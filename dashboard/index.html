<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Home Enhanced Battery SoC v3.2 + Face Recognition - Fixed Version</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #3b82f6;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --background: #0a0e27;
            --surface: #151c3d;
            --surface-light: #1e2951;
            --text-primary: #ffffff;
            --text-secondary: #94a3b8;
            --border: #2a3660;
            --shadow-lg: 0 10px 30px rgba(0, 0, 0, 0.2);
            --gradient-primary: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            --gradient-success: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            --gradient-danger: linear-gradient(135deg, #ef4444 0%, #f87171 100%);
            --gradient-warning: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --instant-color: #00ff41;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--background);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Background Effects */
        .bg-particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .particle {
            position: absolute;
            width: 2px;
            height: 2px;
            background: rgba(59, 130, 246, 0.3);
            border-radius: 50%;
            animation: float 20s infinite linear;
        }

        @keyframes float {
            0% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(-100vh) rotate(360deg); opacity: 0; }
        }

        .bg-animation {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: -2;
            background: linear-gradient(45deg, #0f0f1e, #1a1a2e, #16213e, #0f3460);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Alert Container with auto-dismiss */
        #alertContainer {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            width: 400px;
            max-width: calc(100vw - 40px);
            pointer-events: none;
        }

        #alertContainer .alert {
            pointer-events: all;
            margin-bottom: 10px;
            transform: translateX(100%);
            animation: slideInRight 0.3s ease forwards;
            padding: 16px 20px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--surface);
            border: 1px solid;
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
        }

        @keyframes slideInRight {
            to { transform: translateX(0); }
        }

        .alert::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: currentColor;
        }

        .alert-success { border-color: var(--success-color); color: var(--success-color); }
        .alert-warning { border-color: var(--warning-color); color: var(--warning-color); }
        .alert-danger { border-color: var(--danger-color); color: var(--danger-color); }
        .alert-info { border-color: var(--primary-color); color: var(--primary-color); }

        .alert-close {
            margin-left: auto;
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            font-size: 20px;
            opacity: 0.7;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .alert-close:hover {
            opacity: 1;
            background: rgba(255, 255, 255, 0.1);
        }

        /* Connection Status */
        .connection-status {
            position: fixed;
            top: 20px;
            left: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            background: var(--surface);
            border: 1px solid var(--border);
            z-index: 1000;
        }

        .connection-status.connected {
            color: var(--success-color);
            border-color: var(--success-color);
        }

        .connection-status.disconnected {
            color: var(--danger-color);
            border-color: var(--danger-color);
        }

        /* Security Status */
        .security-status {
            position: fixed;
            top: 70px;
            left: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            background: var(--surface);
            border: 1px solid var(--border);
            z-index: 1000;
        }

        .security-status.armed {
            color: var(--success-color);
            border-color: var(--success-color);
        }

        .security-status.alert {
            color: var(--danger-color);
            border-color: var(--danger-color);
            animation: pulse 1s infinite;
        }

        /* 🔥 NEW: Gas Alert Status */
        .gas-alert-status {
            position: fixed;
            top: 120px;
            left: 20px;
            display: none;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            background: var(--surface);
            border: 1px solid var(--border);
            z-index: 1000;
            animation: pulse 1s infinite;
        }

        .gas-alert-status.warning {
            color: var(--warning-color);
            border-color: var(--warning-color);
            background: rgba(245, 158, 11, 0.1);
            display: flex;
        }

        .gas-alert-status.danger {
            color: var(--danger-color);
            border-color: var(--danger-color);
            background: rgba(239, 68, 68, 0.1);
            display: flex;
        }

        /* Instant Response Status */
        .instant-status {
            position: fixed;
            top: 170px;
            left: 20px;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 2px solid var(--instant-color);
            border-radius: 15px;
            padding: 10px 20px;
            color: var(--instant-color);
            font-weight: 600;
            z-index: 1000;
            animation: instantStatusGlow 2s infinite;
        }

        @keyframes instantStatusGlow {
            0%, 100% { box-shadow: 0 0 10px rgba(0, 255, 65, 0.3); }
            50% { box-shadow: 0 0 20px rgba(0, 255, 65, 0.6); }
        }

        /* CORS Status for Face Recognition */
        .cors-status {
            position: fixed;
            bottom: 20px;
            left: 20px;
            padding: 10px 15px;
            border-radius: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            font-size: 12px;
            z-index: 1000;
        }
        
        .cors-ok {
            background: rgba(34, 197, 94, 0.9) !important;
        }
        
        .cors-error {
            background: rgba(239, 68, 68, 0.9) !important;
        }

        /* Page Containers */
        .page {
            display: none;
            min-height: 100vh;
            position: relative;
        }

        .page.active {
            display: block;
        }

        /* Login Page Styles */
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 24px;
            border: 1px solid var(--glass-border);
            padding: 40px;
            width: 100%;
            max-width: 450px;
            box-shadow: var(--shadow-lg);
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .login-header {
            margin-bottom: 30px;
        }

        .login-header h1 {
            font-size: 2.5rem;
            font-weight: 800;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .login-header p {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .form-input, .input-field {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.08);
            color: var(--text-primary);
            font-size: 15px;
            transition: all 0.3s ease;
        }

        .form-input:focus, .input-field:focus {
            outline: none;
            border-color: var(--primary-color);
            background: rgba(255, 255, 255, 0.12);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
            user-select: none;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px) scale(1.02);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
            box-shadow: 0 4px 14px rgba(59, 130, 246, 0.3);
        }

        .btn-success {
            background: var(--gradient-success);
            color: white;
            box-shadow: 0 4px 14px rgba(16, 185, 129, 0.3);
        }

        .btn-danger {
            background: var(--gradient-danger);
            color: white;
            box-shadow: 0 4px 14px rgba(239, 68, 68, 0.3);
        }

        .btn-warning {
            background: var(--gradient-warning);
            color: white;
            box-shadow: 0 4px 14px rgba(245, 158, 11, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6b7280 0%, #9ca3af 100%);
            color: white;
            box-shadow: 0 4px 14px rgba(107, 114, 128, 0.3);
        }

        .btn-info {
            background: linear-gradient(135deg, #06b6d4 0%, #67e8f9 100%);
            color: white;
            box-shadow: 0 4px 14px rgba(6, 182, 212, 0.3);
        }

        .btn-outline-primary {
            background: transparent;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
        }

        .btn-outline-primary:hover {
            background: var(--primary-color);
            color: white;
        }

        .btn-outline-success {
            background: transparent;
            border: 2px solid var(--success-color);
            color: var(--success-color);
        }

        .btn-outline-success:hover {
            background: var(--success-color);
            color: white;
        }

        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-success {
            background: rgba(16, 185, 129, 0.15);
            border: 1px solid var(--success-color);
            color: var(--success-color);
        }

        .alert-danger {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid var(--danger-color);
            color: var(--danger-color);
        }

        /* Navigation */
        .top-nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--glass-border);
            padding: 15px 30px;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-brand {
            font-size: 1.5rem;
            font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .nav-user {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            background: var(--gradient-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .btn-outline:hover {
            background: var(--primary-color);
            color: white;
        }

        /* Main Dashboard */
        .dashboard-container {
            padding-top: 80px;
            min-height: 100vh;
        }

        .dashboard-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            padding: 0 20px;
        }

        .tab-buttons {
            display: flex;
            background: var(--surface);
            border-radius: 16px;
            padding: 6px;
            border: 1px solid var(--border);
            flex-wrap: wrap;
            gap: 4px;
        }

        .tab-button {
            padding: 12px 24px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .tab-button.active {
            background: var(--gradient-primary);
            color: white;
            box-shadow: 0 4px 14px rgba(59, 130, 246, 0.3);
        }

        .tab-content {
            display: none;
            padding: 0 20px;
        }

        .tab-content.active {
            display: block;
        }

        /* Smart Gate Dashboard Styles */
        .gate-dashboard, .face-dashboard {
            max-width: 1600px;
            margin: 0 auto;
            padding: 24px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
            gap: 28px;
            margin-bottom: 32px;
        }

        .card {
            background: var(--surface);
            border-radius: 24px;
            padding: 28px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-lg);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .card:hover {
            transform: translateY(-4px);
            border-color: var(--primary-color);
        }

        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 24px;
        }

        .card-icon {
            width: 56px;
            height: 56px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            margin-right: 16px;
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        /* Door Control */
        .door-control .card-icon {
            background: var(--gradient-success);
        }

        .door-visualization {
            width: 280px;
            height: 180px;
            margin: 24px auto;
            position: relative;
            perspective: 1200px;
        }

        .door-frame {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border-radius: 12px;
            position: relative;
            border: 4px solid #2a3660;
            overflow: hidden;
        }

        .door-panel {
            width: 85%;
            height: 90%;
            background: var(--gradient-primary);
            position: absolute;
            top: 5%;
            left: 7.5%;
            border-radius: 8px;
            transition: transform 1.5s ease;
            transform-origin: left center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .door-panel::before {
            content: '';
            position: absolute;
            top: 20%;
            right: 10%;
            width: 30%;
            height: 60%;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, transparent 100%);
            border-radius: 8px;
        }

        .door-panel.open {
            transform: perspective(1200px) rotateY(-85deg) translateZ(30px);
            box-shadow: 8px 0 16px rgba(0, 0, 0, 0.4);
        }

        .door-handle {
            width: 14px;
            height: 40px;
            background: var(--gradient-warning);
            border-radius: 14px;
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            box-shadow: 
                0 4px 12px rgba(245, 158, 11, 0.4), 
                inset 0 2px 4px rgba(255, 255, 255, 0.3);
        }

        .door-status {
            margin: 20px 0;
            font-size: 1.35rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 16px 32px;
            border-radius: 20px;
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
        }

        .status-indicator {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-closed { 
            background: var(--gradient-danger);
            color: white;
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3);
        }
        .status-closed .status-indicator { background: white; }

        .status-open { 
            background: var(--gradient-success);
            color: white;
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
        }
        .status-open .status-indicator { background: white; }

        .status-opening, .status-closing { 
            background: var(--gradient-warning);
            color: white;
            animation: pulse-status 2s infinite;
            box-shadow: 0 8px 25px rgba(245, 158, 11, 0.3);
        }
        .status-opening .status-indicator, .status-closing .status-indicator { 
            background: white;
            animation: pulse 0.5s infinite; 
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.2); }
        }

        @keyframes pulse-status {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.02); }
        }

        .control-buttons {
            display: flex;
            gap: 16px;
            justify-content: center;
            margin-top: 24px;
            flex-wrap: wrap;
        }

        /* Face Recognition Styles */
        .face-card-header {
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px 15px 0 0;
            padding: 20px;
            margin: -28px -28px 24px -28px;
        }

        .video-container {
            position: relative;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            background: #000;
            min-height: 400px;
            margin-bottom: 20px;
        }

        #videoStream {
            width: 100%;
            height: auto;
            min-height: 400px;
            max-height: 600px;
            object-fit: contain;
            background: #000;
        }

        .video-fullscreen {
            position: fixed !important;
            top: 0;
            left: 0;
            width: 100vw !important;
            height: 100vh !important;
            z-index: 9999;
            border-radius: 0 !important;
        }

        .video-fullscreen #videoStream {
            width: 100vw;
            height: 100vh;
            max-height: none;
            object-fit: contain;
        }

        .capture-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .video-container:hover .capture-overlay {
            opacity: 1;
        }

        /* CENTERED FACE FRAME FOR BETTER RECOGNITION */
        .face-frame {
            border: 3px solid #4facfe;
            border-radius: 15px;
            width: 280px;
            height: 280px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            opacity: 0.8;
            box-shadow: 0 0 25px rgba(79, 172, 254, 0.7);
            animation: pulse 2s infinite;
            z-index: 10;
        }

        .video-fullscreen .face-frame {
            width: 350px;
            height: 350px;
        }

        .captured-images {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            margin-top: 15px;
            min-height: 120px;
        }

        .captured-image {
            min-width: 100px;
            height: 100px;
            border-radius: 8px;
            object-fit: cover;
            border: 2px solid var(--border);
        }

        .face-list-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid var(--border);
        }

        .loading-spinner {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .progress {
            height: 8px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.1);
            margin-bottom: 15px;
        }

        .progress-bar {
            background: var(--gradient-primary);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        /* Auto capture progress indicator */
        .auto-capture-progress {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.95);
            color: white;
            padding: 30px;
            border-radius: 15px;
            z-index: 2000;
            text-align: center;
            display: none;
            border: 2px solid var(--primary-color);
        }

        .capture-countdown {
            font-size: 3rem;
            font-weight: bold;
            color: #4facfe;
        }

        /* RFID Management */
        .section {
            background: var(--background);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
            position: relative;
        }

        .section-header {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
            gap: 12px;
        }

        .section-header strong {
            font-size: 1.1rem;
            color: var(--text-primary);
        }

        .input-group {
            margin-bottom: 20px;
            position: relative;
        }

        .input-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .scan-section {
            border: 2px dashed var(--border);
            background: rgba(30, 41, 81, 0.3);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .scan-section.scanning {
            border-color: var(--primary-color);
            animation: scanPulse 1.5s infinite;
        }

        @keyframes scanPulse {
            0%, 100% { 
                border-color: var(--primary-color);
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4);
            }
            50% { 
                border-color: #60a5fa;
                box-shadow: 0 0 0 10px rgba(59, 130, 246, 0);
            }
        }

        .scan-status {
            margin: 12px 0;
            padding: 12px;
            border-radius: 10px;
            text-align: center;
            background: var(--surface-light);
            font-weight: 500;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .rfid-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: 12px;
            background: var(--surface);
            margin-top: 20px;
            position: relative;
        }

        .list-item {
            padding: 14px 18px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.3s ease;
        }

        .list-item:hover {
            background: var(--surface-light);
        }

        .list-item:last-child {
            border-bottom: none;
        }

        .list-item-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .list-item-info i {
            color: var(--primary-color);
            font-size: 18px;
        }

        .delete-btn {
            padding: 6px 14px;
            background: var(--gradient-danger);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .delete-btn:hover {
            transform: scale(1.05);
        }

        /* Camera Section */
        .camera-status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding: 12px 16px;
            background: var(--surface-light);
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .camera-status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }

        .camera-status-indicator.online {
            color: var(--success-color);
        }

        .camera-status-indicator.offline {
            color: var(--danger-color);
        }

        .camera-status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .camera-status-dot.online {
            background: var(--success-color);
        }

        .camera-status-dot.offline {
            background: var(--danger-color);
        }

        .camera-ip-display {
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            color: var(--text-secondary);
            padding: 4px 8px;
            background: var(--background);
            border-radius: 6px;
        }

        .security-radar {
            width: 100%;
            height: 240px;
            position: relative;
            background: radial-gradient(circle at center, rgba(30, 41, 81, 0.9) 0%, rgba(10, 14, 39, 1) 100%);
            border-radius: 16px;
            overflow: hidden;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
        }

        .security-radar:hover {
            transform: scale(1.02);
            border: 2px solid rgba(59, 130, 246, 0.5);
        }

        .radar-container {
            width: 200px;
            height: 200px;
            position: relative;
        }

        .radar-circle {
            position: absolute;
            border: 2px solid rgba(59, 130, 246, 0.2);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .radar-circle:nth-child(1) { width: 200px; height: 200px; }
        .radar-circle:nth-child(2) { width: 150px; height: 150px; }
        .radar-circle:nth-child(3) { width: 100px; height: 100px; }
        .radar-circle:nth-child(4) { width: 50px; height: 50px; }

        .radar-sweep {
            position: absolute;
            width: 100%;
            height: 100%;
            background: conic-gradient(
                from 0deg,
                transparent 0deg,
                rgba(59, 130, 246, 0.8) 10deg,
                rgba(59, 130, 246, 0.4) 30deg,
                transparent 60deg
            );
            animation: radarSweep 4s linear infinite;
            border-radius: 50%;
        }

        .radar-sweep.scanning {
            animation-duration: 1s;
            background: conic-gradient(
                from 0deg,
                transparent 0deg,
                rgba(245, 158, 11, 0.8) 10deg,
                rgba(245, 158, 11, 0.4) 30deg,
                transparent 60deg
            );
        }

        @keyframes radarSweep {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .radar-center {
            position: absolute;
            width: 12px;
            height: 12px;
            background: var(--primary-color);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 30px var(--primary-color);
            animation: center-pulse 3s ease-in-out infinite;
        }

        @keyframes center-pulse {
            0%, 100% { 
                transform: translate(-50%, -50%) scale(1);
                box-shadow: 0 0 30px var(--primary-color);
            }
            50% { 
                transform: translate(-50%, -50%) scale(1.3);
                box-shadow: 0 0 50px var(--primary-color);
            }
        }

        .motion-targets {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .motion-targets.motion-active {
            opacity: 1;
        }

        .motion-dot {
            position: absolute;
            width: 12px;
            height: 12px;
            background: radial-gradient(circle, var(--danger-color) 0%, #dc2626 100%);
            border-radius: 50%;
            box-shadow: 
                0 0 25px var(--danger-color),
                inset 0 0 10px rgba(255, 255, 255, 0.3);
            animation: target-ping 2s cubic-bezier(0, 0, 0.2, 1) infinite;
        }

        .motion-dot:nth-child(1) { top: 25%; right: 30%; }
        .motion-dot:nth-child(2) { top: 40%; left: 20%; animation-delay: 0.4s; }
        .motion-dot:nth-child(3) { bottom: 35%; right: 25%; animation-delay: 0.8s; }

        @keyframes target-ping {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(2);
                opacity: 0.5;
            }
            100% {
                transform: scale(3);
                opacity: 0;
            }
        }

        .motion-indicator {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 12px 24px;
            border-radius: 24px;
            font-weight: 600;
            margin: 16px auto;
            width: fit-content;
            transition: all 0.3s ease;
        }

        .motion-indicator-container {
            display: flex;
            justify-content: center;
            width: 100%;
        }

        .motion-detected {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger-color);
            border: 2px solid var(--danger-color);
            animation: alertPulse 1s ease-out infinite;
        }

        @keyframes alertPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .motion-clear {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success-color);
            border: 2px solid var(--success-color);
        }

        .camera-feed {
            width: 100%;
            height: 240px;
            background: var(--surface);
            border-radius: 16px;
            margin: 20px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px dashed var(--border);
            overflow: hidden;
            position: relative;
        }

        .camera-feed.loading {
            border-color: var(--primary-color);
            animation: scanPulse 1.5s infinite;
        }

        .camera-placeholder {
            text-align: center;
            color: var(--text-secondary);
            padding: 20px;
        }

        .camera-placeholder i {
            font-size: 56px;
            margin-bottom: 16px;
            color: var(--primary-color);
            opacity: 0.6;
        }

        .camera-image, .camera-stream {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 14px;
        }

        /* History Section */
        .history-section {
            grid-column: 1 / -1;
        }

        .history-filters {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .filter-group {
            flex: 1;
            min-width: 150px;
        }

        .filter-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .filter-select, .filter-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 10px;
            background: var(--background);
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .filter-select:focus, .filter-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        .history-table-container {
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: var(--background);
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
        }

        .history-table th {
            background: var(--surface-light);
            padding: 16px;
            text-align: left;
            font-weight: 700;
            color: var(--text-primary);
            border-bottom: 2px solid var(--border);
        }

        .history-table td {
            padding: 14px 16px;
            border-bottom: 1px solid var(--border);
            color: var(--text-secondary);
        }

        .history-table tr:hover td {
            background: var(--surface-light);
            color: var(--text-primary);
        }

        .method-badge, .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }

        .method-rfid {
            background: rgba(59, 130, 246, 0.15);
            color: #3b82f6;
        }

        .method-motion {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning-color);
        }

        .status-success {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success-color);
        }

        .status-failed {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger-color);
        }

        .action-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning-color);
        }

        /* Smart Home Dashboard Styles */
        .home-dashboard {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1),
                        inset 0 1px 0 rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .glass-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2),
                        inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        /* Weather Card */
        .weather-card {
            background: var(--gradient-primary);
            position: relative;
            overflow: hidden;
        }

        .weather-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            align-items: center;
        }

        .weather-main {
            text-align: center;
        }

        .weather-icon {
            font-size: 5em;
            margin-bottom: 20px;
            filter: drop-shadow(0 0 20px rgba(255, 255, 255, 0.5));
            animation: weatherFloat 3s ease-in-out infinite;
        }

        @keyframes weatherFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .weather-temp {
            font-size: 4em;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .weather-details {
            display: grid;
            gap: 15px;
        }

        .weather-detail-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .weather-detail-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(5px);
        }

        /* Enhanced Battery Widget Styles */
        .battery-widget {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            padding: 25px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .battery-widget:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 32px rgba(16, 185, 129, 0.2);
        }

        .battery-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .battery-title {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .battery-icon {
            width: 45px;
            height: 45px;
            background: var(--gradient-success);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3em;
        }

        .battery-status-badge {
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-charging {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border: 1px solid #22c55e;
        }

        .status-discharging {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
            border: 1px solid #fbbf24;
        }

        .status-idle {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
            border: 1px solid #3b82f6;
        }

        /* Battery Visualization */
        .battery-visualization {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 30px 0;
            position: relative;
        }

        .battery-container {
            position: relative;
            width: 200px;
            height: 100px;
        }

        .battery-body {
            width: 180px;
            height: 80px;
            border: 4px solid #fff;
            border-radius: 12px;
            position: relative;
            background: linear-gradient(145deg, #1e293b 0%, #0f172a 100%);
            overflow: hidden;
        }

        .battery-terminal {
            width: 12px;
            height: 40px;
            background: #fff;
            border-radius: 0 6px 6px 0;
            position: absolute;
            right: -12px;
            top: 50%;
            transform: translateY(-50%);
        }

        .battery-fill {
            height: 100%;
            transition: all 1s ease;
            position: relative;
            border-radius: 8px;
            overflow: hidden;
        }

        .battery-fill.low {
            background: linear-gradient(90deg, #ef4444 0%, #dc2626 100%);
            animation: batteryLowPulse 2s infinite;
        }

        .battery-fill.medium {
            background: linear-gradient(90deg, #f59e0b 0%, #d97706 100%);
        }

        .battery-fill.high {
            background: linear-gradient(90deg, #10b981 0%, #059669 100%);
        }

        .battery-fill.charging {
            background: linear-gradient(90deg, #22c55e 0%, #16a34a 100%);
            animation: batteryCharging 1.5s infinite;
        }

        @keyframes batteryLowPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        @keyframes batteryCharging {
            0%, 100% { 
                background: linear-gradient(90deg, #22c55e 0%, #16a34a 100%);
                transform: scale(1);
            }
            50% { 
                background: linear-gradient(90deg, #34d399 0%, #22c55e 100%);
                transform: scale(1.02);
            }
        }

        .battery-lightning {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2em;
            color: #fff;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
            animation: lightningFlash 1s infinite;
            display: none;
        }

        .battery-lightning.show {
            display: block;
        }

        @keyframes lightningFlash {
            0%, 50%, 100% { opacity: 1; }
            25%, 75% { opacity: 0.3; }
        }

        .battery-percentage {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.8em;
            font-weight: 700;
            color: #fff;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            z-index: 10;
        }

        /* Battery Details Grid */
        .battery-details-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 25px;
        }

        .battery-detail-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            position: relative;
            transition: all 0.3s ease;
        }

        .battery-detail-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.02);
        }

        .detail-icon {
            font-size: 1.5em;
            margin-bottom: 8px;
            color: var(--success-color);
        }

        .detail-value {
            font-size: 1.4em;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .detail-label {
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        .detail-sublabel {
            font-size: 0.8em;
            color: var(--text-secondary);
            opacity: 0.7;
            margin-top: 2px;
        }

        /* SoC Method Indicators */
        .soc-methods {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
        }

        .soc-method {
            padding: 8px 12px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .method-voltage {
            color: #8b5cf6;
            border-color: rgba(139, 92, 246, 0.3);
        }

        .method-coulomb {
            color: #06b6d4;
            border-color: rgba(6, 182, 212, 0.3);
        }

        .method-combined {
            color: #10b981;
            border-color: rgba(16, 185, 129, 0.3);
            background: rgba(16, 185, 129, 0.1);
        }

        /* 🔧 FIXED: Energy Flow Visualization - No Demo Data */
        .energy-flow-container {
            height: 500px;
            position: relative;
            background: radial-gradient(ellipse at center, rgba(102, 126, 234, 0.1) 0%, transparent 70%);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .energy-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 16px;
            min-width: 400px;
            min-height: 500px;
        }

        /* 🔧 FIXED: Energy stats - Hidden until data available */
        .energy-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 20px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .energy-stats.data-available {
            opacity: 1;
            visibility: visible;
        }

        .energy-stat {
            text-align: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .energy-stat:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .energy-stat::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: var(--gradient-primary);
        }

        .energy-percentage {
            font-size: 2.5em;
            font-weight: 700;
            margin: 10px 0;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .energy-label {
            opacity: 0.8;
        }

        .energy-details {
            font-size: 0.9em;
            opacity: 0.7;
            margin-top: 5px;
        }

        /* 🔧 FIXED: No Data State */
        .energy-no-data {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-secondary);
            text-align: center;
        }

        .energy-no-data i {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .energy-no-data h3 {
            margin-bottom: 10px;
            color: var(--text-primary);
        }

        /* Power Source Indicator */
        .power-source-indicator {
            display: none;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .power-source-indicator.data-available {
            display: flex;
        }

        .power-source-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            animation: powerPulse 2s infinite;
        }

        @keyframes powerPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .power-source-text {
            font-weight: 600;
        }

        /* Validation Indicators */
        .validation-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-left: 5px;
        }

        .validation-indicator.valid {
            background: var(--success-color);
            animation: pulse 2s infinite;
        }

        .validation-indicator.invalid {
            background: var(--danger-color);
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        .room-card {
            position: relative;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid var(--glass-border);
            transition: all 0.3s ease;
        }

        .room-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .room-title {
            font-size: 1.8em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .room-icon {
            width: 50px;
            height: 50px;
            background: var(--gradient-primary);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .room-controls {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .control-button {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.1s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            position: relative;
            overflow: hidden;
            user-select: none;
        }

        .control-button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: radial-gradient(circle, rgba(0, 255, 65, 0.3) 0%, transparent 70%);
            transition: all 0.1s ease;
            transform: translate(-50%, -50%);
        }

        .control-button.active::before {
            width: 100%;
            height: 100%;
        }

        .control-button:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        }

        .control-button.active {
            background: rgba(0, 255, 65, 0.2);
            border-color: var(--instant-color);
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.3);
        }

        .control-icon {
            font-size: 2em;
            transition: all 0.1s ease;
            position: relative;
            z-index: 1;
        }

        .control-button.active .control-icon {
            color: var(--instant-color);
            filter: drop-shadow(0 0 10px rgba(0, 255, 65, 0.5));
        }

        /* Instant Response Animations */
        .control-button.instant-response {
            animation: instantFeedback 0.2s ease;
        }

        @keyframes instantFeedback {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* Fan Animation */
        .fan-icon {
            animation-duration: 2s;
            animation-iteration-count: infinite;
            animation-timing-function: linear;
        }

        .fan-icon.spinning {
            animation-name: fanSpin;
        }

        @keyframes fanSpin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Light Animation */
        .light-icon {
            transition: all 0.1s ease;
        }

        .light-icon.glowing {
            animation: lightGlow 2s ease-in-out infinite;
        }

        @keyframes lightGlow {
            0%, 100% { 
                filter: drop-shadow(0 0 5px rgba(255, 215, 0, 0.5));
                color: #ffd700;
            }
            50% { 
                filter: drop-shadow(0 0 15px rgba(255, 215, 0, 0.8));
                color: #ffed4e;
            }
        }

        /* Sensor Display */
        .sensor-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .sensor-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .sensor-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.05);
        }

        .sensor-value {
            font-size: 2.5em;
            font-weight: 700;
            color: var(--success-color);
            margin: 10px 0;
            transition: all 0.3s ease;
        }

        .sensor-label {
            opacity: 0.8;
            font-size: 0.9em;
        }

        .sensor-status {
            font-size: 0.8em;
            margin-top: 5px;
            padding: 3px 8px;
            border-radius: 8px;
            display: inline-block;
        }

        .sensor-status.calibrating {
            background: var(--warning-color);
            color: #000;
        }

        .sensor-status.ready {
            background: var(--success-color);
            color: #000;
        }

        .sensor-status.warming {
            background: #6b7280;
            color: #fff;
        }

        /* 🔥 FIXED: Gas Alert Animation - Enhanced Visual Warning */
        .gas-alert {
            animation: gasAlert 1s ease-in-out infinite !important;
            border: 2px solid var(--danger-color) !important;
            background: rgba(239, 68, 68, 0.3) !important;
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.5) !important;
        }

        .gas-warning {
            animation: gasWarning 2s ease-in-out infinite !important;
            border: 2px solid var(--warning-color) !important;
            background: rgba(251, 191, 36, 0.3) !important;
            box-shadow: 0 0 15px rgba(251, 191, 36, 0.4) !important;
        }

        @keyframes gasAlert {
            0%, 100% { 
                background: rgba(239, 68, 68, 0.3);
                border-color: var(--danger-color);
                transform: scale(1);
            }
            50% { 
                background: rgba(239, 68, 68, 0.5);
                border-color: #ff6b6b;
                transform: scale(1.02);
            }
        }

        @keyframes gasWarning {
            0%, 100% { 
                background: rgba(251, 191, 36, 0.3);
                border-color: var(--warning-color);
                transform: scale(1);
            }
            50% { 
                background: rgba(251, 191, 36, 0.5);
                border-color: #fcd34d;
                transform: scale(1.01);
            }
        }

        /* Charts Section */
        .charts-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-top: 30px;
        }

        .chart-card {
            height: 300px;
            position: relative;
        }

        .chart-canvas {
            width: 100% !important;
            height: 250px !important;
        }

        /* Admin Panel */
        .admin-panel {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .admin-card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: var(--shadow-lg);
        }

        .admin-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .admin-header h2 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 10px;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .members-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .members-table th,
        .members-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .members-table th {
            background: var(--surface-light);
            font-weight: 600;
            color: var(--text-primary);
        }

        .members-table tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        /* Loading */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid var(--border);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .charts-section {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .main-grid {
                grid-template-columns: 1fr;
            }

            .tab-buttons {
                flex-direction: column;
            }

            .top-nav {
                padding: 15px;
            }

            .nav-user {
                flex-direction: column;
                gap: 10px;
            }

            .weather-content {
                grid-template-columns: 1fr;
            }
            
            .room-controls {
                grid-template-columns: 1fr;
            }
            
            .energy-stats {
                grid-template-columns: 1fr;
            }

            .control-buttons {
                flex-direction: column;
            }

            .history-filters {
                flex-direction: column;
            }

            .camera-status-bar {
                flex-direction: column;
                gap: 8px;
            }

            .battery-visualization {
                margin: 20px 0;
            }
            
            .battery-container {
                width: 160px;
                height: 80px;
            }
            
            .battery-body {
                width: 150px;
                height: 60px;
            }
            
            .battery-percentage {
                font-size: 1.4em;
            }
            
            .battery-details-grid {
                grid-template-columns: 1fr;
            }

            /* Face Recognition Mobile Responsive */
            #videoStream {
                min-height: 300px;
                max-height: 400px;
            }
            
            .face-frame {
                width: 220px;
                height: 220px;
            }
            
            .btn {
                margin-bottom: 5px;
            }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--gradient-primary);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--gradient-success);
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- Background Effects -->
    <div class="bg-animation"></div>
    <div class="bg-particles" id="particles"></div>

    <!-- Alert Container -->
    <div id="alertContainer"></div>

    <!-- Connection Status -->
    <div class="connection-status disconnected" id="connectionStatus">
        <i class="fas fa-circle"></i>
        <span>Connecting...</span>
    </div>

    <!-- Security Status -->
    <div class="security-status armed" id="securityStatus">
        <i class="fas fa-shield-alt"></i>
        <span>System Armed</span>
    </div>

    <!-- 🔥 NEW: Gas Alert Status -->
    <div class="gas-alert-status" id="gasAlertStatus">
        <i class="fas fa-fire"></i>
        <span id="gasAlertText">Gas Alert</span>
    </div>

    <!-- Instant Response Status -->
    <div class="instant-status">
        <i class="fas fa-bolt"></i> INSTANT RESPONSE
    </div>

    <!-- CORS Status for Face Recognition -->
    <div class="cors-status" id="corsStatus">
        <i class="fas fa-circle"></i> CORS: Checking...
    </div>

    <!-- Auto Capture Progress for Face Recognition -->
    <div class="auto-capture-progress" id="autoCaptureProgress">
        <div class="spinner-border text-primary mb-3" role="status"></div>
        <h4 id="captureMessage">Preparing...</h4>
        <div class="capture-countdown" id="captureCountdown"></div>
        <button class="btn btn-danger mt-3" onclick="forceStopCapture()">
            <i class="fas fa-stop"></i> Force Stop
        </button>
    </div>

    <!-- LOGIN PAGE -->
    <div id="loginPage" class="page active">
        <div class="login-container">
            <div class="login-card">
                <div class="login-header">
                    <h1><i class="fas fa-home"></i> Smart Home</h1>
                    <p>Smart Home Management System </p>
                </div>

                <div id="loginAlert"></div>

                <form id="loginForm">
                    <div class="form-group">
                        <label class="form-label">Username</label>
                        <input type="text" class="form-input" id="username" placeholder="Enter username" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-input" id="password" placeholder="Enter password" required>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-sign-in-alt"></i>
                        <span>Login</span>
                    </button>
                </form>

                <div style="margin-top: 20px; padding: 15px; background: rgba(59, 130, 246, 0.1); border-radius: 10px; font-size: 0.9rem;">
                    <div style="font-weight: 600; margin-bottom: 5px;">🔑 Default Account:</div>
                    <div>Username: <code>admin</code></div>
                    <div>Password: <code>admin123</code></div>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN DASHBOARD -->
    <div id="dashboardPage" class="page">
        <!-- Navigation -->
        <nav class="top-nav">
            <div class="nav-brand">
                <i class="fas fa-home"></i> Smart Home v3.2 + AI 🤖
            </div>
            <div class="nav-user">
                <div class="user-info" id="userInfo">
                    <div class="user-avatar" id="userAvatar">A</div>
                    <span id="userDisplayName">Loading...</span>
                </div>
                <button class="btn-outline" id="adminPanelBtn" style="display: none;">
                    <i class="fas fa-cogs"></i> Admin Panel
                </button>
                <button class="btn-outline" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </nav>

        <div class="dashboard-container">
            <!-- Tabs -->
            <div class="dashboard-tabs">
                <div class="tab-buttons">
                    <button class="tab-button active" onclick="switchTab('gate')">
                        <i class="fas fa-door-open"></i>
                        <span>Gate Control</span>
                    </button>
                    <button class="tab-button" onclick="switchTab('home')">
                        <i class="fas fa-home"></i>
                        <span>Home Control</span>
                    </button>
                    <button class="tab-button" onclick="switchTab('face')">
                        <i class="fas fa-user-circle"></i>
                        <span>Face Recognition</span>
                    </button>
                </div>
            </div>

            <!-- Smart Gate Tab -->
            <div id="gateTab" class="tab-content active">
                <div class="gate-dashboard">
                    <div class="dashboard-grid">
                        <!-- Door Control -->
                        <div class="card door-control">
                            <div class="card-header">
                                <div class="card-icon"><i class="fas fa-door-open"></i></div>
                                <div class="card-title">Door Control</div>
                            </div>
                            
                            <div class="door-visualization">
                                <div class="door-frame">
                                    <div class="door-panel" id="doorPanel">
                                        <div class="door-handle"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="door-status status-closed" id="doorStatus">
                                <span class="status-indicator"></span>
                                <span id="doorStatusText">Closed</span>
                            </div>
                            
                            <div class="control-buttons">
                                <button class="btn btn-success" id="btn-open" onclick="controlGate('open')">
                                    <i class="fas fa-unlock"></i>
                                    <span>Open Door</span>
                                </button>
                                <button class="btn btn-danger" id="btn-close" onclick="controlGate('close')">
                                    <i class="fas fa-lock"></i>
                                    <span>Close Door</span>
                                </button>
                            </div>
                        </div>

                        <!-- RFID Management -->
                        <div class="card rfid-management">
                            <div class="card-header">
                                <div class="card-icon" style="background: var(--gradient-primary);"><i class="fas fa-id-card"></i></div>
                                <div class="card-title">RFID Card Management</div>
                            </div>

                            <div class="section">
                                <div class="section-header">
                                    <i class="fas fa-plus-circle"></i>
                                    <strong>Add New RFID Card</strong>
                                </div>
                                
                                <div class="input-group">
                                    <label>RFID Card UID:</label>
                                    <input type="text" class="input-field" id="rfid-uid" placeholder="Enter card UID (e.g. A1B2C3D4)" style="text-transform: uppercase;">
                                </div>
                                <div class="input-group">
                                    <label>Card Owner Name:</label>
                                    <input type="text" class="input-field" id="rfid-name" placeholder="Enter card owner name">
                                </div>
                                
                                <button class="btn btn-success" id="btn-rfid-add" style="width: 100%;" onclick="addRfidCard()">
                                    <i class="fas fa-plus"></i>
                                    <span>Add Card</span>
                                </button>
                            </div>

                            <div class="section">
                                <div class="section-header">
                                    <i class="fas fa-wifi"></i>
                                    <strong>Scan RFID Card</strong>
                                </div>
                                
                                <div class="scan-section" id="rfidScanSection">
                                    <div class="scan-status" id="rfidScanStatus">
                                        Press button to start scanning RFID cards
                                    </div>
                                    
                                    <button class="btn btn-primary" id="btn-rfid-scan" style="width: 100%; margin-top: 12px;" onclick="startRfidScan()">
                                        <i class="fas fa-id-card"></i>
                                        <span>Start Scanning</span>
                                    </button>
                                    <button class="btn btn-danger" id="btn-rfid-stop" style="display: none; width: 100%; margin-top: 12px;" onclick="stopRfidScan()">
                                        <i class="fas fa-stop"></i>
                                        <span>Stop Scanning</span>
                                    </button>
                                </div>

                                <div id="rfid-result" class="result-display" style="margin-top: 16px;"></div>
                            </div>
                            
                            <!-- RFID List -->
                            <div style="margin-top: 20px;">
                                <div style="margin-bottom: 12px; font-weight: 600; color: var(--text-secondary); display: flex; justify-content: space-between; align-items: center;">
                                    <span><i class="fas fa-list"></i> Saved RFID Cards:</span>
                                    <button class="btn btn-warning" style="padding: 6px 12px; font-size: 12px;" id="btn-rfid-clear" onclick="clearAllRfidCards()">
                                        <i class="fas fa-trash"></i> Clear All
                                    </button>
                                </div>
                                
                                <div class="rfid-list" id="rfid-table">
                                    <div style="text-align: center; color: var(--text-secondary); padding: 20px;">
                                        <i class="fas fa-id-card" style="font-size: 48px; opacity: 0.3; margin-bottom: 12px;"></i>
                                        <p>No RFID cards saved yet</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Camera Section -->
                        <div class="card camera-section">
                            <div class="card-header">
                                <div class="card-icon" style="background: var(--gradient-danger);"><i class="fas fa-video"></i></div>
                                <div class="card-title">Security Camera</div>
                            </div>

                            <!-- Camera Status Bar -->
                            <div class="camera-status-bar">
                                <div class="camera-status-indicator offline" id="cameraStatusIndicator">
                                    <div class="camera-status-dot offline"></div>
                                    <span id="cameraStatusText">Camera Offline</span>
                                </div>
                                <div class="camera-ip-display" id="cameraIpDisplay">
                                    Stream: Waiting for connection...
                                </div>
                            </div>

                            <div class="security-radar" id="security-radar" onclick="testMotionDetection()">
                                <div class="radar-container">
                                    <div class="radar-circle"></div>
                                    <div class="radar-circle"></div>
                                    <div class="radar-circle"></div>
                                    <div class="radar-circle"></div>
                                    <div class="radar-sweep" id="radar-sweep"></div>
                                    <div class="radar-center"></div>
                                    <div class="motion-targets">
                                        <div class="motion-dot"></div>
                                        <div class="motion-dot"></div>
                                        <div class="motion-dot"></div>
                                    </div>
                                </div>
                            </div>

                            <div class="motion-indicator-container">
                                <div class="motion-indicator motion-clear" id="motionIndicator">
                                    <i class="fas fa-shield-alt"></i>
                                    <span id="motionText">No Motion Detected</span>
                                </div>
                            </div>

                            <div class="camera-feed" id="cameraFeed">
                                <div class="camera-placeholder">
                                    <i class="fas fa-camera"></i>
                                    <div>Camera stream will be displayed here</div>
                                    <div style="font-size: 14px; margin-top: 10px; opacity: 0.7;">
                                        Auto-connect when ESP32-CAM is online
                                    </div>
                                </div>
                            </div>

                            <div class="control-buttons">
                                <button class="btn btn-primary" id="btn-capture" onclick="capturePhoto()">
                                    <i class="fas fa-camera"></i>
                                    <span>Manual Capture</span>
                                </button>
                                <button class="btn btn-warning" id="btn-stream-toggle" onclick="toggleCameraStream()">
                                    <i class="fas fa-video"></i>
                                    <span>Start Stream</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- History Section -->
                    <div class="card history-section">
                        <div class="card-header">
                            <div class="card-icon" style="background: var(--gradient-warning);"><i class="fas fa-history"></i></div>
                            <div class="card-title">Access History</div>
                        </div>

                        <div class="history-filters">
                            <div class="filter-group">
                                <label>Date:</label>
                                <input type="date" class="filter-input" id="filterDate">
                            </div>
                            <div class="filter-group">
                                <label>Method:</label>
                                <select class="filter-select" id="filterMethod">
                                    <option value="">All Methods</option>
                                    <option value="rfid">RFID Card</option>
                                    <option value="motion">Motion Sensor</option>
                                    <option value="manual">Manual</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Result:</label>
                                <select class="filter-select" id="filterResult">
                                    <option value="">All Results</option>
                                    <option value="success">Success</option>
                                    <option value="failed">Failed</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>&nbsp;</label>
                                <button class="btn btn-primary" id="btn-filter" onclick="applyHistoryFilter()">
                                    <i class="fas fa-filter"></i>
                                    <span>Filter</span>
                                </button>
                            </div>
                        </div>

                        <div class="history-table-container">
                            <table class="history-table">
                                <thead>
                                    <tr>
                                        <th>Time</th>
                                        <th>Method</th>
                                        <th>UID/ID</th>
                                        <th>Name</th>
                                        <th>Result</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="historyTableBody">
                                    <!-- History data will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Smart Home Tab -->
            <div id="homeTab" class="tab-content">
                <div class="home-dashboard">
                    <div class="main-grid">
                        <!-- Weather Section -->
                        <div class="glass-card weather-card">
                            <h2 style="margin-bottom: 20px;"><i class="fas fa-cloud-sun"></i> Hanoi Weather</h2>
                            <div class="weather-content">
                                <div class="weather-main">
                                    <div class="weather-icon" id="weatherIcon">
                                        <i class="fas fa-sun"></i>
                                    </div>
                                    <div class="weather-temp" id="weatherTemp">--°C</div>
                                    <p id="weatherDesc">Loading...</p>
                                </div>
                                <div class="weather-details">
                                    <div class="weather-detail-item">
                                        <i class="fas fa-tint"></i>
                                        <span>Humidity: <strong id="weatherHumidity">--%</strong></span>
                                    </div>
                                    <div class="weather-detail-item">
                                        <i class="fas fa-wind"></i>
                                        <span>Wind: <strong id="weatherWind">-- km/h</strong></span>
                                    </div>
                                    <div class="weather-detail-item">
                                        <i class="fas fa-cloud-rain"></i>
                                        <span>Rain: <strong id="weatherRain">-- mm</strong></span>
                                    </div>
                                    <div class="weather-detail-item">
                                        <i class="fas fa-eye"></i>
                                        <span>Visibility: <strong id="weatherVisibility">-- km</strong></span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Enhanced Battery Widget -->
                        <div class="battery-widget">
                            <div class="battery-header">
                                <div class="battery-title">
                                    <div class="battery-icon">
                                        <i class="fas fa-battery-three-quarters"></i>
                                    </div>
                                    <span>LiPo 4S Battery</span>
                                </div>
                                <div class="battery-status-badge status-idle" id="batteryStatusBadge">
                                    <i class="fas fa-pause"></i>
                                    <span id="batteryStatusText">Idle</span>
                                </div>
                            </div>

                            <div class="battery-visualization">
                                <div class="battery-container">
                                    <div class="battery-body">
                                        <div class="battery-fill high" id="batteryFill" style="width: 0%;">
                                            <div class="battery-lightning" id="batteryLightning">
                                                <i class="fas fa-bolt"></i>
                                            </div>
                                        </div>
                                        <div class="battery-percentage" id="batteryPercentage">0%</div>
                                    </div>
                                    <div class="battery-terminal"></div>
                                </div>
                            </div>

                            <div class="battery-details-grid">
                                <div class="battery-detail-item">
                                    <div class="detail-icon"><i class="fas fa-tachometer-alt"></i></div>
                                    <div class="detail-value" id="batteryVoltage">0.0V</div>
                                    <div class="detail-label">Voltage</div>
                                    <div class="detail-sublabel" id="batteryVoltageRange">12.0V - 16.8V</div>
                                </div>

                                <div class="battery-detail-item">
                                    <div class="detail-icon"><i class="fas fa-bolt"></i></div>
                                    <div class="detail-value" id="batteryCurrent">0A</div>
                                    <div class="detail-label">Current</div>
                                    <div class="detail-sublabel" id="batteryPower">0W</div>
                                </div>

                                <div class="battery-detail-item">
                                    <div class="detail-icon"><i class="fas fa-hourglass-half"></i></div>
                                    <div class="detail-value" id="batteryTimeRemaining">∞</div>
                                    <div class="detail-label">Time Remaining</div>
                                    <div class="detail-sublabel">Estimated</div>
                                </div>

                                <div class="battery-detail-item">
                                    <div class="detail-icon"><i class="fas fa-battery-half"></i></div>
                                    <div class="detail-value" id="batteryCapacityRemaining">0mAh</div>
                                    <div class="detail-label">Capacity Left</div>
                                    <div class="detail-sublabel">/ 4800mAh</div>
                                </div>
                            </div>

                            <div class="soc-methods">
                                <div class="soc-method method-voltage">
                                    <i class="fas fa-chart-line"></i>
                                    <span>Voltage: <span id="socVoltage">0%</span></span>
                                </div>
                                <div class="soc-method method-coulomb">
                                    <i class="fas fa-calculator"></i>
                                    <span>Coulomb: <span id="socCoulomb">0%</span></span>
                                </div>
                                <div class="soc-method method-combined">
                                    <i class="fas fa-star"></i>
                                    <span>Combined: <span id="socCombined">0%</span></span>
                                </div>
                            </div>
                        </div>

                        <!-- 🔧 FIXED: Energy Flow Visualization - Wait for Real Data -->
                        <div class="glass-card">
                            <h2 style="margin-bottom: 20px;"><i class="fas fa-bolt"></i> Energy Flow</h2>
                            
                            <!-- Power Source Indicator - Hidden until data available -->
                            <div class="power-source-indicator" id="powerSourceIndicator">
                                <div class="power-source-icon" id="powerSourceIcon">
                                    <i class="fas fa-plug"></i>
                                </div>
                                <div>
                                    <div class="power-source-text" id="powerSourceText">No Power Source</div>
                                    <div style="font-size: 0.9em; opacity: 0.7;" id="powerSourceDetails">0.0 W</div>
                                </div>
                            </div>
                            
                            <!-- Energy flow visualization - Shows waiting state -->
                            <div class="energy-flow-container" id="energyFlowContainer">
                                <div class="energy-no-data" id="energyNoData">
                                    <i class="fas fa-bolt"></i>
                                    <h3>Waiting for Power Data</h3>
                                    <p>Energy flow will display when ESP32 connects...</p>
                                </div>
                                <canvas id="energyCanvas" class="energy-canvas" style="display: none;"></canvas>
                            </div>
                            
                            <!-- Energy stats - Hidden until data available -->
                            <div class="energy-stats" id="energyStats">
                                <div class="energy-stat">
                                    <div class="energy-percentage" id="solarPercent">0%</div>
                                    <div class="energy-label">
                                        Solar 
                                        <span class="validation-indicator invalid" id="solarValidation"></span>
                                    </div>
                                    <div class="energy-details" id="solarDetails">0.0W | 0.0V</div>
                                </div>
                                <div class="energy-stat">
                                    <div class="energy-percentage" id="batteryPercent">0%</div>
                                    <div class="energy-label">
                                        LiPo Battery 
                                        <span class="validation-indicator invalid" id="batteryValidation"></span>
                                    </div>
                                    <div class="energy-details" id="batteryDetails">0.0W | 0.0V | 0%</div>
                                </div>
                                <div class="energy-stat">
                                    <div class="energy-percentage" id="adapterPercent">0%</div>
                                    <div class="energy-label">
                                        Adapter 
                                        <span class="validation-indicator invalid" id="adapterValidation"></span>
                                    </div>
                                    <div class="energy-details" id="adapterDetails">0.0W | 0.0V</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Rooms Grid -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 30px;">
                        <!-- Living Room -->
                        <div class="room-card">
                            <div class="room-header">
                                <div class="room-title">
                                    <div class="room-icon">
                                        <i class="fas fa-couch"></i>
                                    </div>
                                    <span>Living Room</span>
                                </div>
                            </div>
                            <div class="room-controls">
                                <button class="control-button" id="light1Btn" onclick="toggleHomeDevice('light1')">
                                    <i class="fas fa-lightbulb control-icon light-icon"></i>
                                    <span>Light</span>
                                </button>
                                <button class="control-button" id="fan1Btn" onclick="toggleHomeDevice('fan1')">
                                    <i class="fas fa-fan control-icon fan-icon"></i>
                                    <span>Fan</span>
                                </button>
                            </div>
                            <div class="sensor-grid">
                                <div class="sensor-item">
                                    <i class="fas fa-thermometer-half" style="font-size: 2em; color: #ef4444;"></i>
                                    <div class="sensor-value" id="tempValue">--</div>
                                    <div class="sensor-label">Temperature (°C)</div>
                                </div>
                                <div class="sensor-item">
                                    <i class="fas fa-tint" style="font-size: 2em; color: #3b82f6;"></i>
                                    <div class="sensor-value" id="humidValue">--</div>
                                    <div class="sensor-label">Humidity (%)</div>
                                </div>
                            </div>
                        </div>

                        <!-- 🔥 FIXED: Kitchen with Enhanced Gas Alert -->
                        <div class="room-card">
                            <div class="room-header">
                                <div class="room-title">
                                    <div class="room-icon">
                                        <i class="fas fa-utensils"></i>
                                    </div>
                                    <span>Kitchen</span>
                                </div>
                            </div>
                            <div class="room-controls">
                                <button class="control-button" id="light3Btn" onclick="toggleHomeDevice('light3')">
                                    <i class="fas fa-lightbulb control-icon light-icon"></i>
                                    <span>Light</span>
                                </button>
                                <button class="control-button" id="fan3Btn" onclick="toggleHomeDevice('fan3')">
                                    <i class="fas fa-fan control-icon fan-icon"></i>
                                    <span>Fan</span>
                                </button>
                            </div>
                            <div class="sensor-grid">
                                <div class="sensor-item" style="grid-column: span 2;" id="gasItem">
                                    <i class="fas fa-fire" style="font-size: 2em; color: #f59e0b;"></i>
                                    <div class="sensor-value" id="gasValue">--</div>
                                    <div class="sensor-label">Gas Concentration (ppm)</div>
                                    <div class="sensor-status" id="gasStatus">Starting up...</div>
                                </div>
                            </div>
                        </div>

                        <!-- Bedroom -->
                        <div class="room-card">
                            <div class="room-header">
                                <div class="room-title">
                                    <div class="room-icon">
                                        <i class="fas fa-bed"></i>
                                    </div>
                                    <span>Bedroom</span>
                                </div>
                            </div>
                            <div class="room-controls">
                                <button class="control-button" id="light2Btn" onclick="toggleHomeDevice('light2')">
                                    <i class="fas fa-lightbulb control-icon light-icon"></i>
                                    <span>Light</span>
                                </button>
                                <button class="control-button" id="fan2Btn" onclick="toggleHomeDevice('fan2')">
                                    <i class="fas fa-fan control-icon fan-icon"></i>
                                    <span>Fan</span>
                                </button>
                            </div>
                            <div class="sensor-grid">
                                <div class="sensor-item" style="grid-column: span 2;">
                                    <i class="fas fa-sun" style="font-size: 2em; color: #fbbf24;"></i>
                                    <div class="sensor-value" id="lightStatus">Bright</div>
                                    <div class="sensor-label">Light Status</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Additional Controls -->
                        <div class="room-card">
                            <div class="room-header">
                                <div class="room-title">
                                    <div class="room-icon">
                                        <i class="fas fa-cogs"></i>
                                    </div>
                                    <span>Other Controls</span>
                                </div>
                            </div>
                            <div class="room-controls">
                                <button class="control-button" id="light4Btn" onclick="toggleHomeDevice('light4')">
                                    <i class="fas fa-warehouse control-icon light-icon"></i>
                                    <span>Garage Light</span>
                                </button>
                                <button class="control-button" id="autoLightBtn" onclick="toggleHomeDevice('autoLight')">
                                    <i class="fas fa-magic control-icon"></i>
                                    <span>Auto Light</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Charts Section -->
                    <div class="charts-section">
                        <!-- Temperature & Humidity Chart -->
                        <div class="glass-card chart-card">
                            <h3><i class="fas fa-chart-line"></i> Temperature & Humidity Chart</h3>
                            <canvas id="tempHumidChart" class="chart-canvas"></canvas>
                        </div>
                        
                        <!-- Gas Level Chart -->
                        <div class="glass-card chart-card">
                            <h3><i class="fas fa-chart-area"></i> Gas Concentration Chart</h3>
                            <canvas id="gasChart" class="chart-canvas"></canvas>
                        </div>
                        
                        <!-- Energy Usage Chart -->
                        <div class="glass-card chart-card">
                            <h3><i class="fas fa-chart-bar"></i> Energy Usage Chart</h3>
                            <canvas id="energyChart" class="chart-canvas"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Face Recognition Tab -->
            <div id="faceTab" class="tab-content">
                <div class="face-dashboard">
                    <!-- Video Stream Section -->
                    <div class="card">
                        <div class="face-card-header">
                            <h2><i class="fas fa-eye"></i> AI Face Recognition System</h2>
                        </div>

                        <div class="video-container">
                            <img id="videoStream" src="" alt="Camera Stream" class="img-fluid">
                            <div class="face-frame"></div>
                            <div class="capture-overlay">
                                <button class="btn btn-warning btn-lg" onclick="instantCapture()">
                                    <i class="fas fa-camera"></i> Capture Now
                                </button>
                            </div>
                        </div>
                        
                        <div class="control-buttons">
                            <button class="btn btn-primary" onclick="startStream()">
                                <i class="fas fa-play"></i> Start Stream
                            </button>
                            <button class="btn btn-secondary" onclick="stopStream()">
                                <i class="fas fa-stop"></i> Stop Stream
                            </button>
                            <button class="btn btn-warning" onclick="performRecognition()">
                                <i class="fas fa-search"></i> Recognition
                            </button>
                            <button class="btn btn-info" onclick="toggleFullscreen()">
                                <i class="fas fa-expand"></i> Fullscreen
                            </button>
                        </div>
                    </div>

                    <div class="dashboard-grid">
                        <!-- Enhanced Enrollment Section -->
                        <div class="card">
                            <div class="card-header">
                                <div class="card-icon" style="background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);"><i class="fas fa-user-plus"></i></div>
                                <div class="card-title">Face Enrollment (Fixed Auto Capture)</div>
                            </div>
                            
                            <div class="input-group">
                                <label for="personName" class="form-label">Person Name:</label>
                                <input type="text" class="input-field" id="personName" placeholder="Enter person name..." maxlength="50">
                            </div>
                            
                            <div class="input-group">
                                <label class="form-label">Captured Images: <span id="captureCount">0</span>/5</label>
                                <div class="progress">
                                    <div class="progress-bar" id="captureProgress" style="width: 0%"></div>
                                </div>
                                <div class="captured-images" id="capturedImages">
                                    <!-- Captured images will appear here -->
                                </div>
                            </div>
                            
                            <div class="control-buttons">
                                <button class="btn btn-success" onclick="startFixedEnrollment()" id="startEnrollBtn">
                                    <i class="fas fa-camera"></i> Auto Capture 5 Photos
                                </button>
                                <button class="btn btn-danger" style="display: none;" onclick="stopEnrollment()" id="stopEnrollBtn">
                                    <i class="fas fa-stop"></i> Stop Capture
                                </button>
                                <button class="btn btn-warning" onclick="manualCaptureFixed()">
                                    <i class="fas fa-hand-paper"></i> Manual Capture
                                </button>
                                <button class="btn btn-primary" onclick="enrollFace()" id="enrollBtn" disabled>
                                    <i class="fas fa-plus"></i> Enroll Face
                                </button>
                                <button class="btn btn-secondary" onclick="clearCaptures()">
                                    <i class="fas fa-trash"></i> Clear Images
                                </button>
                            </div>
                        </div>
                        
                        <!-- Face List Section -->
                        <div class="card">
                            <div class="card-header">
                                <div class="card-icon" style="background: var(--gradient-primary);"><i class="fas fa-users"></i></div>
                                <div class="card-title">Face List</div>
                                <button class="btn btn-outline-primary btn-sm" onclick="loadFaceList()" style="margin-left: auto;">
                                    <i class="fas fa-refresh"></i> Refresh
                                </button>
                            </div>
                            
                            <div id="faceList">
                                <div class="loading-spinner">
                                    <div class="loading"></div>
                                    <p style="margin-top: 10px;">Loading list...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ADMIN PANEL -->
    <div id="adminPage" class="page">
        <nav class="top-nav">
            <div class="nav-brand">
                <i class="fas fa-cogs"></i> System Management
            </div>
            <div class="nav-user">
                <button class="btn-outline" onclick="showPage('dashboard')">
                    <i class="fas fa-arrow-left"></i> Back
                </button>
                <button class="btn-outline" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </nav>

        <div class="admin-panel" style="padding-top: 80px;">
            <div class="admin-card">
                <div class="admin-header">
                    <h2><i class="fas fa-users"></i> Member Management</h2>
                    <p>Create and manage member accounts (stored on Firebase)</p>
                </div>

                <div id="adminAlert"></div>

                <form id="createUserForm">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div class="form-group">
                            <label class="form-label">Username</label>
                            <input type="text" class="form-input" id="newUsername" placeholder="Enter username" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Password</label>
                            <input type="password" class="form-input" id="newPassword" placeholder="Enter password" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Display Name</label>
                        <input type="text" class="form-input" id="newDisplayName" placeholder="Enter display name" required>
                    </div>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-user-plus"></i>
                        <span>Create Member</span>
                    </button>
                </form>
            </div>

            <div class="admin-card">
                <h3><i class="fas fa-list"></i> Member List</h3>
                <table class="members-table">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Display Name</th>
                            <th>Role</th>
                            <th>Created Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="membersTableBody">
                        <!-- Members will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // =================================================================
        // FIREBASE CONFIGURATION - FIXED TO MATCH ESP32
        // =================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyAO-6fXi3A_gLZz_uf9JKpQUOuxLfu6r1I",
            authDomain: "smart-home-b7a03.firebaseapp.com",
            databaseURL: "https://smart-home-b7a03-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "smart-home-b7a03",
            storageBucket: "smart-home-b7a03.firebasestorage.app",
            messagingSenderId: "700486399783",
            appId: "1:700486399783:web:9700f5683c1c1070319b02",
            measurementId: "G-LMQRQB76XP"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // =================================================================
        // FACE RECOGNITION CONFIGURATION
        // =================================================================
        const FACE_CONFIG = {
            ESP32_STREAM_URL: 'https://streamesp32facecam.myfreeiot.win',
            ESP32_API_URL: 'https://apiesp32facecam.myfreeiot.win',
            AI_SERVER_URL: 'https://pyfaceid.myfreeiot.win',
            USE_SEPARATED_DOMAINS: true,
            MAX_RETRY_ATTEMPTS: 3,
            CAPTURE_TIMEOUT: 8000
        };

        // =================================================================
        // GLOBAL VARIABLES & STATE - FIXED GAS ALERT + ENERGY FLOW
        // =================================================================
        let currentUser = null;
        let usersData = {};

        let systemState = {
            isConnected: false,
            doorStatus: 'closed',
            motionDetected: false,
            rfidList: [],
            accessHistory: [],
            cameraOnline: false,
            cameraStreamUrl: 'https://esp32stream.myfreeiot.win/stream',
            isStreaming: false,
            scanInProgress: false,
            existingCards: {},
            failCount: 0,
            gateCurrentStatus: 'closed',
            currentCameraIP: '',
            // 🔥 NEW: Gas alert state
            gasAlertActive: false,
            gasLevel: 'NORMAL',
            gasPPM: 0
        };

        // Face Recognition State
        let faceState = {
            capturedImages: [],
            isEnrolling: false,
            streamInterval: null,
            corsStatus: 'unknown',
            lastCaptureTime: 0,
            captureQueue: [],
            enrollmentActive: false
        };

        // Device states
        let deviceStates = {
            gateStatus: 'closed',
            light1: false, light2: false, light3: false, light4: false,
            fan1: false, fan2: false, fan3: false, autoLight: false
        };

        // Charts and energy flow
        let energyFlowAnimation;
        let charts = {};
        let sensorData = {
            temp: [], humid: [], gas: [], timestamps: []
        };
        let energyData = {
            solar: [], battery: [], adapter: [], timestamps: []
        };
        
        let latestSensorValues = {
            temp: null,
            humid: null,
            lastTempTime: 0,
            lastHumidTime: 0
        };
        
        // 🔧 FIXED: Energy flow state - No demo data
        let energyFlowState = {
            hasData: false,
            currentPowerSource: 0,
            powerValidation: {
                solar: false,
                battery: false,
                adapter: false
            }
        };
        
        let gasCalibrationStatus = 'warming';

        // INSTANT RESPONSE OPTIMIZATIONS
        let pendingCommands = new Set();
        let commandQueue = [];
        let lastCommandTime = 0;

        // Enhanced Battery Configuration for 4S Li-ion (4x18650 1200mAh)
        const BATTERY_CONFIG = {
            CAPACITY_MAH: 4800,
            CELLS: 4,
            CELL_CAPACITY_MAH: 1200,
            DISCHARGE_RATE: 3,
            NOMINAL_VOLTAGE: 14.8,
            MIN_VOLTAGE: 12.0,
            MAX_VOLTAGE: 16.8,
            MIN_POWER_THRESHOLD_W: 15,
            MAX_POWER_W: 57.6
        };

        // =================================================================
        // ALERT MANAGER WITH AUTO-DISMISS AND CLICKABLE CLOSE
        // =================================================================
        const alertManager = {
            alerts: new Map(),
            alertCounter: 0,
            
            show(id, message, type = 'success', timeout = 3000) {
                this.remove(id);
                
                const alertId = `alert-${id}-${++this.alertCounter}`;
                const container = document.getElementById('alertContainer');
                const alert = document.createElement('div');
                alert.className = `alert alert-${type}`;
                alert.id = alertId;
                alert.innerHTML = `
                    <i class="fas fa-${this.getIcon(type)}"></i>
                    <span>${message}</span>
                    <button class="alert-close" onclick="alertManager.removeById('${alertId}')" title="Close notification">×</button>
                `;
                
                container.appendChild(alert);
                this.alerts.set(alertId, { element: alert, timeout: null });
                
                if (timeout > 0) {
                    const timeoutId = setTimeout(() => {
                        this.removeById(alertId);
                    }, timeout);
                    this.alerts.get(alertId).timeout = timeoutId;
                }
                
                console.log(`🔔 Alert: ${message} (ID: ${alertId}, Auto-close: ${timeout}ms)`);
            },
            
            getIcon(type) {
                const icons = {
                    success: 'check-circle',
                    warning: 'exclamation-triangle',
                    danger: 'exclamation-circle',
                    info: 'info-circle'
                };
                return icons[type] || 'info-circle';
            },
            
            removeById(alertId) {
                const alertData = this.alerts.get(alertId);
                if (alertData) {
                    if (alertData.timeout) {
                        clearTimeout(alertData.timeout);
                    }
                    
                    if (alertData.element && alertData.element.parentElement) {
                        alertData.element.style.transform = 'translateX(100%)';
                        setTimeout(() => {
                            if (alertData.element.parentElement) {
                                alertData.element.remove();
                            }
                            this.alerts.delete(alertId);
                        }, 300);
                    }
                    
                    console.log(`🔔 Alert removed: ${alertId}`);
                }
            },
            
            remove(id) {
                const alertsToRemove = [];
                this.alerts.forEach((alertData, alertId) => {
                    if (alertId.includes(`alert-${id}-`)) {
                        alertsToRemove.push(alertId);
                    }
                });
                
                alertsToRemove.forEach(alertId => this.removeById(alertId));
            },
            
            clearAll() {
                this.alerts.forEach((alertData, alertId) => {
                    this.removeById(alertId);
                });
            }
        };

        // =================================================================
        // 🔥 FIXED: GAS ALERT MANAGEMENT SYSTEM
        // =================================================================
        function updateGasAlertStatus(level, ppm, message) {
            const gasAlertStatus = document.getElementById('gasAlertStatus');
            const gasAlertText = document.getElementById('gasAlertText');
            
            systemState.gasLevel = level;
            systemState.gasPPM = ppm;
            
            if (level === 'DANGER') {
                systemState.gasAlertActive = true;
                gasAlertStatus.className = 'gas-alert-status danger';
                gasAlertText.textContent = `DANGER! ${ppm} ppm`;
                
                // Show major alert notification
                alertManager.show('gas-danger', `🚨 GAS DANGER! Concentration: ${ppm} ppm - Evacuate immediately!`, 'danger', 10000);
                
                console.log(`🔥 GAS DANGER ALERT: ${ppm} ppm`);
                
            } else if (level === 'WARNING') {
                systemState.gasAlertActive = true;
                gasAlertStatus.className = 'gas-alert-status warning';
                gasAlertText.textContent = `Warning: ${ppm} ppm`;
                
                // Show warning notification
                alertManager.show('gas-warning', `⚠️ Gas Warning: ${ppm} ppm - Check for leaks!`, 'warning', 7000);
                
                console.log(`🔥 GAS WARNING: ${ppm} ppm`);
                
            } else {
                // Normal level - hide alert
                systemState.gasAlertActive = false;
                gasAlertStatus.style.display = 'none';
                
                // Clear gas alerts
                alertManager.remove('gas-danger');
                alertManager.remove('gas-warning');
                
                console.log(`🔥 Gas level normal: ${ppm} ppm`);
            }
        }

        // =================================================================
        // 🔧 FIXED: ENERGY FLOW VISUALIZATION - WAIT FOR REAL DATA
        // =================================================================
        class EnergyFlowVisualization {
            constructor(canvasId) {
                this.canvas = document.getElementById(canvasId);
                if (!this.canvas) {
                    console.error('❌ Canvas element not found:', canvasId);
                    return;
                }
                
                this.ctx = this.canvas.getContext('2d');
                if (!this.ctx) {
                    console.error('❌ Cannot get 2D context from canvas');
                    return;
                }
                
                console.log('✅ Canvas found and context created - WAITING for ESP32 data');
                
                this.nodes = {
                    solar: { x: 0.15, y: 0.15, name: 'Solar', color: '#f59e0b', power: 0, voltage: 0, valid: false },
                    battery: { x: 0.85, y: 0.15, name: 'LiPo Battery', color: '#10b981', power: 0, voltage: 0, valid: false },
                    adapter: { x: 0.15, y: 0.85, name: 'Adapter', color: '#ef4444', power: 0, voltage: 0, valid: false },
                    home: { x: 0.5, y: 0.5, name: 'Home', color: '#3b82f6', power: 0 }
                };
                this.particles = [];
                this.isInitialized = false;
                this.animationId = null;
                this.hasRealData = false;
                
                this.resize();
                window.addEventListener('resize', () => this.resize());
                
                // 🔧 FIXED: Don't initialize with demo data, wait for real data
                console.log('🔧 Energy Flow: Waiting for real ESP32 power data...');
            }
            
            resize() {
                const rect = this.canvas.parentElement.getBoundingClientRect();
                const width = Math.max(rect.width, 400);
                const height = Math.max(rect.height, 500);
                
                this.canvas.width = width;
                this.canvas.height = height;
                
                console.log(`🔧 Canvas resized to: ${width} x ${height}`);
                
                if (this.isInitialized && this.hasRealData) {
                    this.draw();
                }
            }
            
            // 🔧 FIXED: Only start animation when we have real data
            startAnimationLoop() {
                if (this.animationId) {
                    cancelAnimationFrame(this.animationId);
                }
                
                const animate = () => {
                    if (this.hasRealData) {
                        this.draw();
                    }
                    this.animationId = requestAnimationFrame(animate);
                };
                
                animate();
                this.isInitialized = true;
                console.log('🔧 Energy Flow Animation: Started (will display when data available)');
            }
            
            draw() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                if (!this.hasRealData) {
                    return; // Don't draw anything without real data
                }
                
                // Draw static connections first
                this.drawStaticConnections();
                
                // Draw active connections (only if we have real data)
                this.drawActiveConnections();
                
                // Draw nodes
                Object.values(this.nodes).forEach(node => this.drawNode(node));
                
                // Update and draw particles
                this.updateParticles();
            }
            
            hasActivePowerFlow() {
                return Object.values(this.nodes).some(node => 
                    node.name !== 'Home' && node.valid && Math.abs(node.power) > 0.05);
            }
            
            drawStaticConnections() {
                const connections = [
                    [this.nodes.solar, this.nodes.home],
                    [this.nodes.battery, this.nodes.home],
                    [this.nodes.adapter, this.nodes.home]
                ];
                
                this.ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
                this.ctx.lineWidth = 1;
                this.ctx.setLineDash([5, 5]);
                
                connections.forEach(([from, to]) => {
                    const x1 = from.x * this.canvas.width;
                    const y1 = from.y * this.canvas.height;
                    const x2 = to.x * this.canvas.width;
                    const y2 = to.y * this.canvas.height;
                    
                    this.ctx.beginPath();
                    this.ctx.moveTo(x1, y1);
                    this.ctx.lineTo(x2, y2);
                    this.ctx.stroke();
                });
                
                this.ctx.setLineDash([]);
            }
            
            drawActiveConnections() {
                const hasValidData = this.hasActivePowerFlow();
                
                if (!hasValidData) return;
                
                const validPowers = [];
                if (this.nodes.solar.valid && this.nodes.solar.power > 0.05) validPowers.push(this.nodes.solar.power);
                if (this.nodes.battery.valid && Math.abs(this.nodes.battery.power) > 0.05) validPowers.push(Math.abs(this.nodes.battery.power));
                if (this.nodes.adapter.valid && this.nodes.adapter.power > 0.05) validPowers.push(this.nodes.adapter.power);
                
                const maxPower = Math.max(...validPowers, 0.1);
                const maxDisplayPower = Math.min(maxPower, 15);
                
                if (this.nodes.solar.valid && this.nodes.solar.power > 0.05) {
                    const intensity = Math.min(this.nodes.solar.power / maxDisplayPower, 1);
                    this.drawConnection(this.nodes.solar, this.nodes.home, true, intensity);
                }
                
                if (this.nodes.battery.valid && Math.abs(this.nodes.battery.power) > 0.05) {
                    const intensity = Math.min(Math.abs(this.nodes.battery.power) / maxDisplayPower, 1);
                    const isCharging = this.nodes.battery.power < 0;
                    if (isCharging) {
                        this.drawConnection(this.nodes.home, this.nodes.battery, true, intensity);
                    } else {
                        this.drawConnection(this.nodes.battery, this.nodes.home, true, intensity);
                    }
                }
                
                if (this.nodes.adapter.valid && this.nodes.adapter.power > 0.05) {
                    const intensity = Math.min(this.nodes.adapter.power / maxDisplayPower, 1);
                    this.drawConnection(this.nodes.adapter, this.nodes.home, true, intensity);
                }
            }
            
            drawConnection(from, to, active, intensity = 1) {
                if (!active || !from.valid || Math.abs(from.power) <= 0.05) return;
                
                const x1 = from.x * this.canvas.width;
                const y1 = from.y * this.canvas.height;
                const x2 = to.x * this.canvas.width;
                const y2 = to.y * this.canvas.height;
                
                const gradient = this.ctx.createLinearGradient(x1, y1, x2, y2);
                gradient.addColorStop(0, from.color);
                gradient.addColorStop(1, to.color + '80');
                
                this.ctx.strokeStyle = gradient;
                this.ctx.lineWidth = 3 * intensity;
                this.ctx.setLineDash([10, 5]);
                this.ctx.lineDashOffset = Date.now() / 100;
                
                this.ctx.beginPath();
                this.ctx.moveTo(x1, y1);
                this.ctx.lineTo(x2, y2);
                this.ctx.stroke();
                
                this.ctx.setLineDash([]);
                
                this.createEnergyParticles(x1, y1, x2, y2, from.color, intensity);
            }
            
            createEnergyParticles(x1, y1, x2, y2, color, intensity) {
                const particleSpeed = 0.01 + (intensity * 0.02);
                const particleCount = Math.ceil(intensity * 3);
                
                for (let i = 0; i < particleCount; i++) {
                    if (Math.random() < 0.1) {
                        this.particles.push({
                            x: x1,
                            y: y1,
                            targetX: x2,
                            targetY: y2,
                            progress: Math.random() * 0.3,
                            speed: particleSpeed * (0.8 + Math.random() * 0.4),
                            color: color,
                            size: 3 + Math.random() * 4,
                            life: 1.0
                        });
                    }
                }
            }
            
            updateParticles() {
                this.particles = this.particles.filter(particle => {
                    particle.progress += particle.speed;
                    particle.life -= 0.01;
                    
                    if (particle.progress >= 1 || particle.life <= 0) {
                        return false;
                    }
                    
                    particle.x = particle.x + (particle.targetX - particle.x) * particle.speed * 2;
                    particle.y = particle.y + (particle.targetY - particle.y) * particle.speed * 2;
                    
                    const gradient = this.ctx.createRadialGradient(
                        particle.x, particle.y, 0,
                        particle.x, particle.y, particle.size * 2
                    );
                    gradient.addColorStop(0, particle.color + Math.floor(particle.life * 255).toString(16).padStart(2, '0'));
                    gradient.addColorStop(1, 'transparent');
                    
                    this.ctx.fillStyle = gradient;
                    this.ctx.beginPath();
                    this.ctx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
                    this.ctx.fill();
                    
                    this.ctx.fillStyle = particle.color;
                    this.ctx.beginPath();
                    this.ctx.arc(particle.x, particle.y, particle.size * 0.4, 0, Math.PI * 2);
                    this.ctx.fill();
                    
                    return true;
                });
            }
            
            drawNode(node) {
                const x = node.x * this.canvas.width;
                const y = node.y * this.canvas.height;
                const radius = 35;
                
                const nodeColor = node.valid !== false ? node.color : '#6b7280';
                
                if (node.valid && Math.abs(node.power) > 0.05) {
                    const gradient = this.ctx.createRadialGradient(x, y, 0, x, y, radius * 2);
                    gradient.addColorStop(0, nodeColor + '40');
                    gradient.addColorStop(1, 'transparent');
                    this.ctx.fillStyle = gradient;
                    this.ctx.fillRect(x - radius * 2, y - radius * 2, radius * 4, radius * 4);
                }
                
                this.ctx.beginPath();
                this.ctx.arc(x, y, radius, 0, Math.PI * 2);
                this.ctx.fillStyle = nodeColor;
                this.ctx.fill();
                
                if (node.valid !== false && Math.abs(node.power) > 0.05) {
                    const powerIntensity = Math.min(Math.abs(node.power) / 15, 1);
                    this.ctx.beginPath();
                    this.ctx.arc(x, y, radius + 5, 0, Math.PI * 2);
                    this.ctx.strokeStyle = nodeColor;
                    this.ctx.lineWidth = 3 * powerIntensity;
                    this.ctx.stroke();
                }
                
                this.ctx.beginPath();
                this.ctx.arc(x, y, radius, 0, Math.PI * 2);
                this.ctx.strokeStyle = node.valid !== false ? '#fff' : '#666';
                this.ctx.lineWidth = 2;
                this.ctx.stroke();
                
                if (node.name !== 'Home') {
                    const indicatorX = x + radius - 8;
                    const indicatorY = y - radius + 8;
                    this.ctx.beginPath();
                    this.ctx.arc(indicatorX, indicatorY, 6, 0, Math.PI * 2);
                    this.ctx.fillStyle = node.valid ? '#4ade80' : '#ef4444';
                    this.ctx.fill();
                }
                
                this.ctx.fillStyle = node.valid !== false ? '#fff' : '#999';
                this.ctx.font = 'bold 12px Inter, sans-serif';
                this.ctx.textAlign = 'center';
                this.ctx.fillText(node.name, x, y - 8);
                this.ctx.font = '10px Inter, sans-serif';
                this.ctx.fillText(Math.abs(node.power).toFixed(1) + ' W', x, y + 5);
                if (node.voltage !== undefined) {
                    this.ctx.fillText(node.voltage.toFixed(1) + ' V', x, y + 16);
                }
            }
            
            // 🔧 FIXED: Update method with real data detection
            update(powerSource, powers, validations) {
                console.log('🔧 Energy Flow: Receiving ESP32 data', powers, validations);
                
                // Mark that we now have real data from ESP32
                this.hasRealData = true;
                
                // Show canvas and hide no-data message
                document.getElementById('energyNoData').style.display = 'none';
                document.getElementById('energyCanvas').style.display = 'block';
                
                // Update node data with real ESP32 data
                this.nodes.solar.power = powers.solar || 0;
                this.nodes.solar.voltage = powers.solarV || 0;
                this.nodes.solar.valid = validations.solar;
                
                this.nodes.battery.power = powers.battery || 0;
                this.nodes.battery.voltage = powers.batteryV || 0;
                this.nodes.battery.valid = validations.battery;
                
                this.nodes.adapter.power = powers.adapter || 0;
                this.nodes.adapter.voltage = powers.adapterV || 0;
                this.nodes.adapter.valid = validations.adapter;
                
                this.nodes.home.power = powers.total || 0;
                
                // Start animation if not already running
                if (!this.isInitialized) {
                    this.startAnimationLoop();
                }
                
                console.log('🔧 Energy Flow: Updated with real ESP32 data');
            }
            
            destroy() {
                if (this.animationId) {
                    cancelAnimationFrame(this.animationId);
                    this.animationId = null;
                }
                window.removeEventListener('resize', this.resize);
            }
        }

        // =================================================================
        // CORS STATUS MANAGEMENT FOR FACE RECOGNITION
        // =================================================================
        function updateCORSStatus(status, message = '') {
            const indicator = document.getElementById('corsStatus');
            faceState.corsStatus = status;
            
            if (status === 'ok') {
                indicator.className = 'cors-status cors-ok';
                indicator.innerHTML = '<i class="fas fa-check"></i> CORS: OK';
            } else if (status === 'error') {
                indicator.className = 'cors-status cors-error';
                indicator.innerHTML = '<i class="fas fa-times"></i> CORS: Error';
            } else {
                indicator.className = 'cors-status';
                indicator.innerHTML = '<i class="fas fa-spinner fa-spin"></i> CORS: Testing...';
            }
            
            if (message) {
                console.log('CORS Status:', message);
            }
        }

        // =================================================================
        // FACE RECOGNITION CAPTURE FUNCTIONS
        // =================================================================
        
        // Enhanced Capture with Multiple Fallback Methods
        async function captureImageAdvanced(method = 'auto') {
            const startTime = Date.now();
            const captureId = `capture_${startTime}`;
            
            console.log(`[${captureId}] Starting advanced capture with method: ${method}`);
            
            if (startTime - faceState.lastCaptureTime < 500) {
                console.log(`[${captureId}] Rate limited - too soon after last capture`);
                return null;
            }
            
            faceState.lastCaptureTime = startTime;
            
            const methods = [
                () => captureViaProxy(captureId),
                () => captureViaDirectHTTPS(captureId),
                () => captureViaImageElement(captureId),
                () => captureViaFetch(captureId)
            ];
            
            let lastError = null;
            
            for (let i = 0; i < methods.length; i++) {
                try {
                    console.log(`[${captureId}] Trying method ${i + 1}/${methods.length}`);
                    
                    const blob = await Promise.race([
                        methods[i](),
                        new Promise((_, reject) => 
                            setTimeout(() => reject(new Error('Timeout')), FACE_CONFIG.CAPTURE_TIMEOUT)
                        )
                    ]);
                    
                    if (blob && blob.size > 1000) {
                        console.log(`[${captureId}] Success with method ${i + 1} - Size: ${blob.size} bytes`);
                        updateCORSStatus('ok', 'Capture successful');
                        return blob;
                    }
                } catch (error) {
                    console.log(`[${captureId}] Method ${i + 1} failed:`, error.message);
                    lastError = error;
                }
            }
            
            console.log(`[${captureId}] All methods failed`);
            updateCORSStatus('error', 'All capture methods failed');
            throw lastError || new Error('All capture methods failed');
        }

        // Method 1: Enhanced Proxy Capture
        async function captureViaProxy(captureId) {
            console.log(`[${captureId}] Trying proxy method`);
            
            const response = await fetch(`${FACE_CONFIG.AI_SERVER_URL}/proxy/capture`, {
                method: 'GET',
                headers: {
                    'Accept': 'image/jpeg,image/*',
                    'Cache-Control': 'no-cache',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                credentials: 'omit'
            });
            
            if (!response.ok) {
                throw new Error(`Proxy returned ${response.status}`);
            }
            
            const blob = await response.blob();
            console.log(`[${captureId}] Proxy blob size: ${blob.size}`);
            
            return blob;
        }

        // Method 2: Direct HTTPS Capture (using API domain)
        async function captureViaDirectHTTPS(captureId) {
            console.log(`[${captureId}] Trying direct HTTPS method via API domain`);
            
            const response = await fetch(`${FACE_CONFIG.ESP32_API_URL}/capture?t=${Date.now()}&direct=1`, {
                method: 'GET',
                mode: 'cors',
                cache: 'no-store',
                credentials: 'omit',
                headers: {
                    'Accept': 'image/jpeg'
                }
            });
            
            if (!response.ok) {
                throw new Error(`Direct HTTPS returned ${response.status}`);
            }
            
            return await response.blob();
        }

        // Method 3: Image Element Capture (using API domain)
        async function captureViaImageElement(captureId) {
            console.log(`[${captureId}] Trying image element method via API domain`);
            
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = "anonymous";
                
                const timeout = setTimeout(() => {
                    reject(new Error('Image load timeout'));
                }, 5000);
                
                img.onload = function() {
                    clearTimeout(timeout);
                    try {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        canvas.width = img.naturalWidth;
                        canvas.height = img.naturalHeight;
                        ctx.drawImage(img, 0, 0);
                        
                        canvas.toBlob((blob) => {
                            if (blob) {
                                resolve(blob);
                            } else {
                                reject(new Error('Canvas toBlob failed'));
                            }
                        }, 'image/jpeg', 0.8);
                    } catch (error) {
                        reject(error);
                    }
                };
                
                img.onerror = () => {
                    clearTimeout(timeout);
                    reject(new Error('Image load error'));
                };
                
                img.src = `${FACE_CONFIG.ESP32_API_URL}/capture?t=${Date.now()}&img=1`;
            });
        }

        // Method 4: Fetch with Custom Headers (using API domain)
        async function captureViaFetch(captureId) {
            console.log(`[${captureId}] Trying custom fetch method via API domain`);
            
            const response = await fetch(`${FACE_CONFIG.ESP32_API_URL}/capture`, {
                method: 'GET',
                headers: {
                    'Accept': 'image/jpeg,*/*',
                    'Cache-Control': 'no-cache, no-store',
                    'Pragma': 'no-cache'
                }
            });
            
            if (!response.ok) {
                throw new Error(`Custom fetch returned ${response.status}`);
            }
            
            return await response.blob();
        }

        // =================================================================
        // FACE RECOGNITION ENROLLMENT FUNCTIONS
        // =================================================================
        
        // Fixed Auto Enrollment System
        async function startFixedEnrollment() {
            const personName = document.getElementById('personName').value.trim();
            if (!personName) {
                alertManager.show('face-error', '❌ Please enter person name!', 'danger');
                return;
            }
            
            if (personName.length < 2) {
                alertManager.show('face-error', '❌ Name must be at least 2 characters!', 'danger');
                return;
            }
            
            faceState.capturedImages = [];
            faceState.isEnrolling = true;
            faceState.enrollmentActive = true;
            
            document.getElementById('enrollBtn').disabled = true;
            document.getElementById('startEnrollBtn').disabled = true;
            document.getElementById('stopEnrollBtn').style.display = 'inline-flex';
            updateCaptureProgress();
            
            const progressOverlay = document.getElementById('autoCaptureProgress');
            progressOverlay.style.display = 'block';
            
            alertManager.show('face-auto-start', '🚀 Starting Auto Capture 5 photos with fixed system!', 'info', 3000);
            
            try {
                await performAutoCapture();
            } catch (error) {
                console.error('Auto enrollment error:', error);
                alertManager.show('face-auto-error', `❌ Auto capture error: ${error.message}`, 'danger');
            } finally {
                faceState.isEnrolling = false;
                faceState.enrollmentActive = false;
                progressOverlay.style.display = 'none';
                document.getElementById('startEnrollBtn').disabled = false;
                document.getElementById('stopEnrollBtn').style.display = 'none';
                document.getElementById('enrollBtn').disabled = faceState.capturedImages.length < 3;
            }
        }

        // Enhanced Auto Capture Logic
        async function performAutoCapture() {
            const totalImages = 5;
            let successCount = 0;
            let attemptCount = 0;
            const maxAttempts = 10;
            
            const messageEl = document.getElementById('captureMessage');
            const countdownEl = document.getElementById('captureCountdown');
            
            for (let i = 3; i > 0; i--) {
                if (!faceState.enrollmentActive) throw new Error('Stopped by user');
                
                messageEl.textContent = 'Preparing to capture...';
                countdownEl.textContent = i;
                await sleep(1000);
            }
            
            while (successCount < totalImages && attemptCount < maxAttempts && faceState.enrollmentActive) {
                attemptCount++;
                
                try {
                    messageEl.textContent = `Capturing image ${successCount + 1}/${totalImages} (Attempt ${attemptCount})`;
                    countdownEl.textContent = '📸';
                    
                    const blob = await captureImageAdvanced('auto');
                    
                    if (blob && blob.size > 1000) {
                        faceState.capturedImages.push(blob);
                        successCount++;
                        updateCaptureProgress();
                        flashEffect();
                        
                        alertManager.show('face-capture-success', `✅ Image ${successCount}/${totalImages} captured successfully!`, 'success', 1000);
                        
                        if (successCount < totalImages) {
                            await sleep(800);
                        }
                    } else {
                        throw new Error('Invalid image captured');
                    }
                    
                } catch (error) {
                    console.log(`Capture attempt ${attemptCount} failed:`, error.message);
                    alertManager.show('face-capture-retry', `⚠️ Attempt ${attemptCount} failed, retrying...`, 'warning', 1000);
                    
                    await sleep(500);
                }
            }
            
            if (successCount >= totalImages) {
                alertManager.show('face-capture-complete', `🎉 Completed! Captured ${successCount}/${totalImages} images successfully!`, 'success', 5000);
            } else if (!faceState.enrollmentActive) {
                alertManager.show('face-capture-stopped', '⏹️ Stopped by user', 'warning');
            } else {
                alertManager.show('face-capture-partial', `⚠️ Only captured ${successCount}/${totalImages} images after ${attemptCount} attempts`, 'warning', 5000);
            }
        }

        // Utility Functions
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function forceStopCapture() {
            faceState.enrollmentActive = false;
            faceState.isEnrolling = false;
            alertManager.show('face-force-stop', '🛑 Force stopped auto capture!', 'warning');
        }

        // Fixed Manual Capture
        async function manualCaptureFixed() {
            try {
                alertManager.show('face-manual-start', '📸 Manual capture with fixed system...', 'info');
                
                const blob = await captureImageAdvanced('manual');
                
                if (blob && blob.size > 1000) {
                    faceState.capturedImages.push(blob);
                    updateCaptureProgress();
                    flashEffect();
                    
                    alertManager.show('face-manual-success', `✅ Manual capture successful! (${faceState.capturedImages.length}/5)`, 'success');
                    
                    if (faceState.capturedImages.length >= 3) {
                        document.getElementById('enrollBtn').disabled = false;
                    }
                } else {
                    throw new Error('Invalid or too small image');
                }
                
            } catch (error) {
                console.error('Manual capture error:', error);
                alertManager.show('face-manual-error', `❌ Manual capture failed: ${error.message}`, 'danger');
            }
        }

        // Fixed Recognition
        async function performRecognition() {
            try {
                alertManager.show('face-recog-start', '🔍 Recognition with fixed system...', 'info');
                
                const blob = await captureImageAdvanced('recognition');
                
                const formData = new FormData();
                formData.append('image', blob, 'recognition.jpg');
                
                alertManager.show('face-ai-analyzing', '🤖 AI analyzing face...', 'info');
                
                const response = await fetch(`${FACE_CONFIG.AI_SERVER_URL}/recognize`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error(`AI Server Error: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success && result.name && result.name !== 'Unknown') {
                    const confidence = (result.confidence * 100).toFixed(1);
                    alertManager.show('face-recog-success', `✅ Recognized: ${result.name} (${confidence}%)`, 'success', 5000);
                } else {
                    alertManager.show('face-recog-unknown', '❌ Face not recognized!', 'danger', 3000);
                }
                
            } catch (error) {
                console.error('Recognition error:', error);
                alertManager.show('face-recog-error', `❌ Recognition error: ${error.message}`, 'danger');
            }
        }

        // Instant Capture (for overlay button)
        async function instantCapture() {
            try {
                const blob = await captureImageAdvanced('instant');
                alertManager.show('face-instant-success', '✅ Instant capture successful!', 'success');
                flashEffect();
            } catch (error) {
                alertManager.show('face-instant-error', `❌ Instant capture error: ${error.message}`, 'danger');
            }
        }

        // =================================================================
        // FACE RECOGNITION UTILITY FUNCTIONS
        // =================================================================
        
        function flashEffect() {
            const videoContainer = document.querySelector('.video-container');
            if (!videoContainer) return;
            
            const flash = document.createElement('div');
            flash.style.cssText = `
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: white;
                opacity: 0.8;
                z-index: 1000;
                pointer-events: none;
            `;
            videoContainer.appendChild(flash);
            
            setTimeout(() => {
                flash.remove();
            }, 150);
        }

        function updateCaptureProgress() {
            const count = faceState.capturedImages.length;
            document.getElementById('captureCount').textContent = count;
            document.getElementById('captureProgress').style.width = `${(count / 5) * 100}%`;
            
            const container = document.getElementById('capturedImages');
            container.innerHTML = '';
            
            faceState.capturedImages.forEach((blob, index) => {
                const img = document.createElement('img');
                img.src = URL.createObjectURL(blob);
                img.className = 'captured-image';
                img.alt = `Image ${index + 1}`;
                container.appendChild(img);
            });
        }

        function clearCaptures() {
            faceState.capturedImages = [];
            faceState.isEnrolling = false;
            faceState.enrollmentActive = false;
            document.getElementById('enrollBtn').disabled = true;
            document.getElementById('startEnrollBtn').disabled = false;
            document.getElementById('stopEnrollBtn').style.display = 'none';
            updateCaptureProgress();
            alertManager.show('face-clear', '🗑️ Cleared all images', 'info');
        }

        function stopEnrollment() {
            faceState.enrollmentActive = false;
            forceStopCapture();
        }

        // Stream management (using dedicated stream domain)
        function startStream() {
            const videoStream = document.getElementById('videoStream');
            const streamUrl = `${FACE_CONFIG.ESP32_STREAM_URL}/stream?t=${Date.now()}`;
            
            alertManager.show('face-stream-start', '📡 Connecting to dedicated stream domain...', 'info', 2000);
            
            videoStream.src = streamUrl;
            videoStream.onload = () => {
                alertManager.show('face-stream-connected', '✅ Stream started via dedicated TCP connection', 'success', 3000);
            };
            
            videoStream.onerror = () => {
                alertManager.show('face-stream-error', '❌ Stream failed - check ESP32-CAM stream domain', 'danger');
            };
        }

        function stopStream() {
            document.getElementById('videoStream').src = '';
            alertManager.show('face-stream-stop', '⏹️ Stream stopped - API domain free for captures', 'info', 2000);
        }

        function toggleFullscreen() {
            const videoContainer = document.querySelector('.video-container');
            if (!videoContainer) return;
            
            const isFullscreen = videoContainer.classList.contains('video-fullscreen');
            
            if (isFullscreen) {
                videoContainer.classList.remove('video-fullscreen');
                document.body.style.overflow = 'auto';
            } else {
                videoContainer.classList.add('video-fullscreen');
                document.body.style.overflow = 'hidden';
            }
        }

        // =================================================================
        // FACE MANAGEMENT FUNCTIONS
        // =================================================================
        async function enrollFace() {
            const personName = document.getElementById('personName').value.trim();
            if (!personName || faceState.capturedImages.length < 3) {
                alertManager.show('face-enroll-error', 'Need at least 3 images to enroll!', 'danger');
                return;
            }
            
            try {
                alertManager.show('face-enroll-processing', '🤖 Processing enrollment with AI...', 'info');
                
                const formData = new FormData();
                formData.append('name', personName);
                
                faceState.capturedImages.forEach((blob, index) => {
                    formData.append(`image${index}`, blob, `image${index}.jpg`);
                });
                
                const response = await fetch(`${FACE_CONFIG.AI_SERVER_URL}/enroll`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alertManager.show('face-enroll-success', `✅ Successfully enrolled ${personName}!`, 'success', 5000);
                    clearCaptures();
                    document.getElementById('personName').value = '';
                    loadFaceList();
                } else {
                    alertManager.show('face-enroll-failed', `❌ Enrollment error: ${result.message}`, 'danger');
                }
                
            } catch (error) {
                alertManager.show('face-enroll-network-error', `❌ AI connection error: ${error.message}`, 'danger');
            }
        }

        async function loadFaceList() {
            try {
                const response = await fetch(`${FACE_CONFIG.AI_SERVER_URL}/list`);
                const result = await response.json();
                const container = document.getElementById('faceList');
                
                if (result.success && result.faces && result.faces.length > 0) {
                    container.innerHTML = result.faces.map(face => `
                        <div class="face-list-item">
                            <div>
                                <strong><i class="fas fa-user"></i> ${face.name}</strong>
                                <br>
                                <small class="text-muted">
                                    <i class="fas fa-images"></i> ${face.images_count} images
                                </small>
                            </div>
                            <button class="btn btn-danger btn-sm" onclick="deleteFace('${face.name}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<p class="text-muted text-center">No faces enrolled yet</p>';
                }
                
            } catch (error) {
                document.getElementById('faceList').innerHTML = '<p style="color: var(--danger-color); text-align: center;">Error loading list</p>';
            }
        }

        async function deleteFace(name) {
            if (!confirm(`Delete ${name}?`)) return;
            
            try {
                const response = await fetch(`${FACE_CONFIG.AI_SERVER_URL}/delete`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: name })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alertManager.show('face-delete-success', `Deleted ${name}`, 'success');
                    loadFaceList();
                } else {
                    alertManager.show('face-delete-error', `Delete error: ${result.message}`, 'danger');
                }
                
            } catch (error) {
                alertManager.show('face-delete-network-error', 'Error deleting face!', 'danger');
            }
        }

        // =================================================================
        // FIREBASE USER MANAGEMENT SYSTEM
        // =================================================================
        
        // Initialize default admin user in Firebase
        async function initializeDefaultAdmin() {
            try {
                const adminRef = database.ref('/users/admin');
                const snapshot = await adminRef.once('value');
                
                if (!snapshot.exists()) {
                    console.log('🔥 Creating default admin user in Firebase...');
                    await adminRef.set({
                        password: 'admin123',
                        displayName: 'Administrator',
                        role: 'admin',
                        createdAt: Date.now(),
                        createdBy: 'system'
                    });
                    console.log('✅ Default admin user created');
                }
            } catch (error) {
                console.error('❌ Error initializing admin user:', error);
            }
        }

        // Load users from Firebase
        async function loadUsersFromFirebase() {
            try {
                const snapshot = await database.ref('/users').once('value');
                if (snapshot.exists()) {
                    usersData = snapshot.val();
                    console.log('🔥 Users loaded from Firebase:', Object.keys(usersData));
                } else {
                    console.log('🔥 No users found in Firebase');
                    usersData = {};
                }
            } catch (error) {
                console.error('❌ Error loading users from Firebase:', error);
                usersData = {};
            }
        }

        // Enhanced Login function with fallback
        async function login(username, password) {
            try {
                console.log('🔥 Attempting login for:', username);
                
                const loginBtn = document.querySelector('#loginForm button');
                const originalText = loginBtn.innerHTML;
                loginBtn.innerHTML = '<div class="loading"></div> Logging in...';
                loginBtn.disabled = true;
                
                if (username === 'admin' && password === 'admin123') {
                    console.log('🔧 Using fallback admin login');
                    currentUser = {
                        username: 'admin',
                        displayName: 'Administrator',
                        role: 'admin'
                    };
                    
                    localStorage.setItem('smartHomeCurrentUser', JSON.stringify(currentUser));
                    showLoginAlert('✅ Login successful! (Fallback mode)', 'success');
                    
                    setTimeout(() => {
                        showPage('dashboard');
                        updateUserDisplay();
                    }, 1000);
                    
                    return true;
                }
                
                try {
                    await loadUsersFromFirebase();
                    
                    if (usersData[username] && usersData[username].password === password) {
                        currentUser = {
                            username: username,
                            displayName: usersData[username].displayName,
                            role: usersData[username].role || 'member'
                        };
                        
                        localStorage.setItem('smartHomeCurrentUser', JSON.stringify(currentUser));
                        showLoginAlert('✅ Login successful!', 'success');
                        
                        setTimeout(() => {
                            showPage('dashboard');
                            updateUserDisplay();
                        }, 1000);
                        
                        return true;
                    }
                } catch (firebaseError) {
                    console.warn('Firebase login failed, trying fallback...', firebaseError);
                    
                    const fallbackUsers = {
                        'admin': { password: 'admin123', displayName: 'Administrator', role: 'admin' },
                        'test': { password: 'test123', displayName: 'Test User', role: 'member' }
                    };
                    
                    if (fallbackUsers[username] && fallbackUsers[username].password === password) {
                        currentUser = {
                            username: username,
                            displayName: fallbackUsers[username].displayName,
                            role: fallbackUsers[username].role
                        };
                        
                        localStorage.setItem('smartHomeCurrentUser', JSON.stringify(currentUser));
                        showLoginAlert('✅ Login successful! (Offline mode)', 'success');
                        
                        setTimeout(() => {
                            showPage('dashboard');
                            updateUserDisplay();
                        }, 1000);
                        
                        return true;
                    }
                }
                
                showLoginAlert('❌ Invalid username or password!', 'danger');
                return false;
                
            } catch (error) {
                console.error('❌ Login error:', error);
                showLoginAlert('❌ Login error: ' + error.message, 'danger');
                return false;
            } finally {
                const loginBtn = document.querySelector('#loginForm button');
                loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i><span>Login</span>';
                loginBtn.disabled = false;
            }
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('smartHomeCurrentUser');
            showPage('login');
            resetForms();
            alertManager.show('logout', '👋 Logged out successfully', 'info', 2000);
        }

        async function checkAuth() {
            const savedUser = localStorage.getItem('smartHomeCurrentUser');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    
                    await loadUsersFromFirebase();
                    if (usersData[currentUser.username]) {
                        showPage('dashboard');
                        updateUserDisplay();
                        return true;
                    } else {
                        localStorage.removeItem('smartHomeCurrentUser');
                        currentUser = null;
                        showLoginAlert('⚠️ Account no longer exists. Please login again.', 'warning');
                    }
                } catch (error) {
                    console.error('❌ Auth check error:', error);
                    localStorage.removeItem('smartHomeCurrentUser');
                    currentUser = null;
                }
            }
            return false;
        }

        function updateUserDisplay() {
            if (currentUser) {
                document.getElementById('userDisplayName').textContent = currentUser.displayName;
                document.getElementById('userAvatar').textContent = currentUser.displayName.charAt(0).toUpperCase();
                
                if (currentUser.role === 'admin') {
                    document.getElementById('adminPanelBtn').style.display = 'block';
                } else {
                    document.getElementById('adminPanelBtn').style.display = 'none';
                }
            }
        }

        // =================================================================
        // FIREBASE USER MANAGEMENT (ADMIN ONLY)
        // =================================================================
        async function createUser(username, password, displayName) {
            if (!currentUser || currentUser.role !== 'admin') {
                showAdminAlert('❌ You do not have permission to perform this action!', 'danger');
                return false;
            }
            
            try {
                console.log('🔥 Creating user:', username);
                
                const createBtn = document.querySelector('#createUserForm button');
                const originalText = createBtn.innerHTML;
                createBtn.innerHTML = '<div class="loading"></div> Creating...';
                createBtn.disabled = true;
                
                const userRef = database.ref(`/users/${username}`);
                const snapshot = await userRef.once('value');
                
                if (snapshot.exists()) {
                    showAdminAlert('❌ Username already exists!', 'danger');
                    return false;
                }
                
                const userData = {
                    password: password,
                    displayName: displayName,
                    role: 'member',
                    createdAt: Date.now(),
                    createdBy: currentUser.username
                };
                
                await userRef.set(userData);
                
                usersData[username] = userData;
                
                showAdminAlert('✅ Member created successfully!', 'success');
                updateMembersTable();
                document.getElementById('createUserForm').reset();
                
                console.log('✅ User created successfully in Firebase');
                return true;
                
            } catch (error) {
                console.error('❌ Create user error:', error);
                showAdminAlert('❌ Error creating member: ' + error.message, 'danger');
                return false;
            } finally {
                const createBtn = document.querySelector('#createUserForm button');
                createBtn.innerHTML = '<i class="fas fa-user-plus"></i><span>Create Member</span>';
                createBtn.disabled = false;
            }
        }

        async function deleteUser(username) {
            if (!currentUser || currentUser.role !== 'admin') {
                showAdminAlert('❌ You do not have permission to perform this action!', 'danger');
                return;
            }
            
            if (username === 'admin') {
                showAdminAlert('❌ Cannot delete admin account!', 'danger');
                return;
            }
            
            if (confirm(`🗑️ Are you sure you want to delete member "${username}"?\n\nThis action cannot be undone!`)) {
                try {
                    console.log('🔥 Deleting user:', username);
                    
                    await database.ref(`/users/${username}`).remove();
                    
                    delete usersData[username];
                    
                    showAdminAlert('✅ Member deleted successfully!', 'success');
                    updateMembersTable();
                    
                    console.log('✅ User deleted successfully from Firebase');
                    
                } catch (error) {
                    console.error('❌ Delete user error:', error);
                    showAdminAlert('❌ Error deleting member: ' + error.message, 'danger');
                }
            }
        }

        async function updateMembersTable() {
            const tbody = document.getElementById('membersTableBody');
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;"><div class="loading"></div> Loading...</td></tr>';
            
            try {
                await loadUsersFromFirebase();
                
                tbody.innerHTML = '';
                
                if (Object.keys(usersData).length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--text-secondary);">No members yet</td></tr>';
                    return;
                }
                
                Object.entries(usersData).forEach(([username, userData]) => {
                    const row = document.createElement('tr');
                    const createdDate = userData.createdAt ? 
                        new Date(userData.createdAt).toLocaleDateString('en-US') : 
                        'N/A';
                    
                    row.innerHTML = `
                        <td>${username}</td>
                        <td>${userData.displayName}</td>
                        <td>
                            <span style="padding: 4px 12px; border-radius: 12px; font-size: 0.8em; background: ${
                                userData.role === 'admin' ? 'var(--danger-color)' : 'var(--primary-color)'
                            }; color: white;">
                                ${userData.role === 'admin' ? 'Administrator' : 'Member'}
                            </span>
                        </td>
                        <td>${createdDate}</td>
                        <td>
                            ${username !== 'admin' ? 
                                `<button class="btn btn-danger" style="padding: 6px 12px; font-size: 0.8em;" onclick="deleteUser('${username}')">
                                    <i class="fas fa-trash"></i> Delete
                                </button>` : 
                                '<span style="opacity: 0.5;">Cannot delete</span>'
                            }
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                });
                
            } catch (error) {
                console.error('❌ Error updating members table:', error);
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--danger-color);">❌ Error loading data</td></tr>';
            }
        }

        // =================================================================
        // ENHANCED BATTERY WIDGET FUNCTIONS - FIXED FOR 4S Li-ion
        // =================================================================
        
        function calculateBatterySoC(voltage) {
            const voltageCurve = [
                [12.0, 0], [12.4, 3], [12.8, 8], [13.2, 15], [13.6, 25], [14.0, 40],
                [14.4, 55], [14.8, 70], [15.2, 80], [15.6, 90], [16.0, 96], [16.8, 100]
            ];
            
            if (voltage <= BATTERY_CONFIG.MIN_VOLTAGE) return 0;
            if (voltage >= BATTERY_CONFIG.MAX_VOLTAGE) return 100;
            
            for (let i = 0; i < voltageCurve.length - 1; i++) {
                if (voltage >= voltageCurve[i][0] && voltage <= voltageCurve[i + 1][0]) {
                    const v1 = voltageCurve[i][0];
                    const soc1 = voltageCurve[i][1];
                    const v2 = voltageCurve[i + 1][0];
                    const soc2 = voltageCurve[i + 1][1];
                    
                    const soc = soc1 + ((voltage - v1) / (v2 - v1)) * (soc2 - soc1);
                    return Math.max(0, Math.min(100, soc));
                }
            }
            
            return 0;
        }

        function updateBatteryWidget(batteryData) {
            if (!batteryData) return;
            
            const combinedSoC = batteryData.soc?.combined || 0;
            const voltageSoC = batteryData.soc?.voltage || 0;
            const coulombSoC = batteryData.soc?.coulomb || 0;
            
            const voltage = batteryData.voltage || 0;
            const current = (batteryData.current || 0) / 1000;
            const power = (batteryData.power || 0) / 1000;
            const isCharging = batteryData.is_charging || false;
            const isDischarging = batteryData.is_discharging || false;
            const remainingMah = batteryData.remaining_mah || 0;
            const timeRemaining = batteryData.time_remaining || 0;
            
            let displaySoC = combinedSoC;
            if (combinedSoC === 0 && voltage > 0) {
                displaySoC = calculateBatterySoC(voltage);
                console.log(`🔋 Calculated SoC from voltage: ${voltage}V → ${displaySoC.toFixed(1)}%`);
            }
            
            document.getElementById('batteryPercentage').textContent = displaySoC.toFixed(0) + '%';
            
            const batteryFill = document.getElementById('batteryFill');
            const batteryLightning = document.getElementById('batteryLightning');
            
            batteryFill.style.width = displaySoC + '%';
            
            batteryFill.className = 'battery-fill';
            
            if (isCharging) {
                batteryFill.classList.add('charging');
                batteryLightning.classList.add('show');
            } else {
                batteryLightning.classList.remove('show');
                
                if (displaySoC <= 20) {
                    batteryFill.classList.add('low');
                } else if (displaySoC <= 60) {
                    batteryFill.classList.add('medium');
                } else {
                    batteryFill.classList.add('high');
                }
            }
            
            const statusBadge = document.getElementById('batteryStatusBadge');
            const statusText = document.getElementById('batteryStatusText');
            
            statusBadge.className = 'battery-status-badge';
            
            if (isCharging) {
                statusBadge.classList.add('status-charging');
                statusText.innerHTML = '<i class="fas fa-plug"></i> Charging';
            } else if (isDischarging) {
                statusBadge.classList.add('status-discharging');
                statusText.innerHTML = '<i class="fas fa-arrow-down"></i> Discharging';
            } else {
                statusBadge.classList.add('status-idle');
                statusText.innerHTML = '<i class="fas fa-pause"></i> Idle';
            }
            
            document.getElementById('batteryVoltage').textContent = voltage.toFixed(2) + 'V';
            document.getElementById('batteryCurrent').textContent = current.toFixed(2) + 'A';
            document.getElementById('batteryPower').textContent = Math.abs(power).toFixed(1) + 'W';
            
            const calculatedRemainingMah = (displaySoC / 100) * BATTERY_CONFIG.CAPACITY_MAH;
            const finalRemainingMah = remainingMah > 0 ? remainingMah : calculatedRemainingMah;
            document.getElementById('batteryCapacityRemaining').textContent = finalRemainingMah.toFixed(0) + 'mAh';
            
            const timeRemainingElement = document.getElementById('batteryTimeRemaining');
            if (timeRemaining > 0 && isDischarging) {
                if (timeRemaining < 1) {
                    timeRemainingElement.textContent = (timeRemaining * 60).toFixed(0) + 'm';
                } else {
                    timeRemainingElement.textContent = timeRemaining.toFixed(1) + 'h';
                }
            } else if (current > 0 && isDischarging && displaySoC > 0) {
                const estimatedHours = finalRemainingMah / (current * 1000);
                if (estimatedHours < 24) {
                    timeRemainingElement.textContent = estimatedHours.toFixed(1) + 'h';
                } else {
                    timeRemainingElement.textContent = '∞';
                }
            } else {
                timeRemainingElement.textContent = '∞';
            }
            
            document.getElementById('socVoltage').textContent = voltageSoC.toFixed(1) + '%';
            document.getElementById('socCoulomb').textContent = coulombSoC.toFixed(1) + '%';
            document.getElementById('socCombined').textContent = displaySoC.toFixed(1) + '%';
            
            const batteryIcon = document.querySelector('.battery-icon i');
            if (batteryIcon) {
                batteryIcon.className = 'fas';
                
                if (displaySoC <= 10) {
                    batteryIcon.classList.add('fa-battery-empty');
                } else if (displaySoC <= 25) {
                    batteryIcon.classList.add('fa-battery-quarter');
                } else if (displaySoC <= 50) {
                    batteryIcon.classList.add('fa-battery-half');
                } else if (displaySoC <= 75) {
                    batteryIcon.classList.add('fa-battery-three-quarters');
                } else {
                    batteryIcon.classList.add('fa-battery-full');
                }
            }
            
            document.getElementById('batteryVoltageRange').textContent = 
                `${BATTERY_CONFIG.MIN_VOLTAGE}V - ${BATTERY_CONFIG.MAX_VOLTAGE}V`;
                
            console.log(`🔋 Battery: ${voltage.toFixed(2)}V, ${current.toFixed(2)}A, ${Math.abs(power).toFixed(1)}W, SoC: ${displaySoC.toFixed(1)}%, ${finalRemainingMah.toFixed(0)}mAh`);
        }

        // =================================================================
        // UI FUNCTIONS
        // =================================================================
        function showPage(pageName) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            if (pageName === 'login') {
                document.getElementById('loginPage').classList.add('active');
            } else if (pageName === 'dashboard') {
                document.getElementById('dashboardPage').classList.add('active');
                
                // Initialize Firebase connection immediately
                initializeFirebaseApp();
                
                // 🔧 FIXED: Don't initialize energy flow with demo data
                setTimeout(() => {
                    initializeEnergyFlowVisualization();
                    initializeCharts();
                    updateWeather();
                }, 100);
                
                // Initialize Face Recognition components when dashboard loads
                setTimeout(() => {
                    initializeFaceRecognition();
                }, 200);
                
            } else if (pageName === 'admin') {
                if (currentUser && currentUser.role === 'admin') {
                    document.getElementById('adminPage').classList.add('active');
                    updateMembersTable();
                } else {
                    showLoginAlert('❌ You do not have permission to access this page!', 'danger');
                }
            }
        }

        // =================================================================
        // FACE RECOGNITION INITIALIZATION
        // =================================================================
        function initializeFaceRecognition() {
            console.log('🤖 Initializing Face Recognition System...');
            
            updateCORSStatus('unknown', 'Starting face recognition system...');
            
            setTimeout(() => {
                loadFaceList();
            }, 1000);
            
            console.log('=== Face Recognition Domain Separation Architecture ===');
            console.log('Stream Domain:', FACE_CONFIG.ESP32_STREAM_URL);
            console.log('API Domain:', FACE_CONFIG.ESP32_API_URL);
            console.log('AI Server:', FACE_CONFIG.AI_SERVER_URL);
            
            if (document.getElementById('faceTab').classList.contains('active')) {
                startStream();
            }
        }

        // =================================================================
        // FIREBASE INITIALIZATION
        // =================================================================
        async function initializeFirebaseApp() {
            try {
                console.log('🔥 Initializing Firebase connection...');
                
                updateConnectionStatus(true);
                systemState.isConnected = true;
                
                await initializeDefaultAdmin();
                
                setupFirebaseListeners();
                
                await database.ref('test/connection').set({
                    timestamp: Date.now(),
                    user: currentUser?.username || 'anonymous',
                    message: 'Dashboard v3.2 Enhanced Battery SoC + Face Recognition connected'
                });
                
                console.log('✅ Firebase connected successfully');
                alertManager.show('firebase-connected', '🔥 Firebase connected successfully!', 'success', 2000);
                
            } catch (error) {
                console.error('❌ Firebase connection error:', error);
                updateConnectionStatus(false);
                systemState.isConnected = false;
                alertManager.show('firebase-error', '❌ Firebase connection error. Retrying...', 'warning', 3000);
                
                setTimeout(() => {
                    initializeFirebaseApp();
                }, 3000);
            }
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.closest('.tab-button').classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            if (tabName === 'gate') {
                document.getElementById('gateTab').classList.add('active');
            } else if (tabName === 'home') {
                document.getElementById('homeTab').classList.add('active');
            } else if (tabName === 'face') {
                document.getElementById('faceTab').classList.add('active');
                setTimeout(() => {
                    if (!faceState.streamInterval) {
                        initializeFaceRecognition();
                        startStream();
                    }
                }, 100);
            }
        }

        function showLoginAlert(message, type) {
            const alertContainer = document.getElementById('loginAlert');
            alertContainer.innerHTML = `
                <div class="alert alert-${type}">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                    <span>${message}</span>
                </div>
            `;
            
            setTimeout(() => {
                alertContainer.innerHTML = '';
            }, 5000);
        }

        function showAdminAlert(message, type) {
            const alertContainer = document.getElementById('adminAlert');
            alertContainer.innerHTML = `
                <div class="alert alert-${type}">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                    <span>${message}</span>
                </div>
            `;
            
            setTimeout(() => {
                alertContainer.innerHTML = '';
            }, 5000);
        }

        function resetForms() {
            document.getElementById('loginForm').reset();
            if (document.getElementById('createUserForm')) {
                document.getElementById('createUserForm').reset();
            }
        }

        // =================================================================
        // PARTICLE SYSTEM
        // =================================================================
        function createParticles() {
            const particlesContainer = document.getElementById('particles');
            const particleCount = 50;
            
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 20 + 's';
                particle.style.animationDuration = (Math.random() * 10 + 10) + 's';
                particlesContainer.appendChild(particle);
            }
        }

        // =================================================================
        // DEVICE CONTROL FUNCTIONS
        // =================================================================
        async function controlGate(command) {
            try {
                await database.ref('/gate/command').set(command);
                alertManager.show('gate-command', `✅ Gate ${command === 'open' ? 'open' : 'close'} command sent`, 'success', 2000);
                console.log(`🚪 Gate command sent: ${command}`);
                
                document.getElementById('btn-open').disabled = true;
                document.getElementById('btn-close').disabled = true;
                
                setTimeout(() => {
                    document.getElementById('btn-open').disabled = false;
                    document.getElementById('btn-close').disabled = false;
                }, 3000);
                
            } catch (error) {
                console.error('❌ Error controlling gate:', error);
                alertManager.show('gate-error', '❌ Gate control error: ' + error.message, 'danger', 3000);
            }
        }

        // INSTANT RESPONSE: Toggle Device with immediate UI feedback
        function toggleHomeDevice(device) {
            const currentTime = Date.now();
            
            if (pendingCommands.has(device) || (currentTime - lastCommandTime < 100)) {
                console.log(`⚡ Command throttled: ${device}`);
                return;
            }
            
            const newState = !deviceStates[device];
            lastCommandTime = currentTime;
            
            console.log(`⚡ INSTANT: Toggling ${device} to ${newState}`);
            
            const btn = document.getElementById(device + 'Btn');
            if (btn) {
                btn.classList.add('instant-response');
                updateDeviceUI(device, newState);
                
                setTimeout(() => {
                    btn.classList.remove('instant-response');
                }, 200);
            }
            
            deviceStates[device] = newState;
            pendingCommands.add(device);
            
            const commandPromise = database.ref(`commands/${device}`).set(newState)
                .then(() => {
                    console.log(`⚡ Command sent successfully: ${device} = ${newState}`);
                    alertManager.show('device-control', 
                        `✅ ${device.replace(/(\d+)/, ' $1')} ${newState ? 'turned on' : 'turned off'}`, 
                        'success', 3000);
                    pendingCommands.delete(device);
                })
                .catch((error) => {
                    console.error('⚠️ Error sending command:', error);
                    deviceStates[device] = !newState;
                    updateDeviceUI(device, !newState);
                    pendingCommands.delete(device);
                    alertManager.show('device-error', 
                        `❌ Cannot control ${device}`, 
                        'danger', 3000);
                });
            
            commandQueue.push({
                device,
                state: newState,
                timestamp: currentTime,
                promise: commandPromise
            });
            
            commandQueue = commandQueue.filter(cmd => currentTime - cmd.timestamp < 5000);
        }

        function updateDeviceUI(device, state) {
            const btn = document.getElementById(device + 'Btn');
            if (btn) {
                if (state) {
                    btn.classList.add('active');
                    
                    if (device.includes('fan')) {
                        const fanIcon = btn.querySelector('.fan-icon');
                        if (fanIcon) fanIcon.classList.add('spinning');
                    }
                    if (device.includes('light')) {
                        const lightIcon = btn.querySelector('.light-icon');
                        if (lightIcon) lightIcon.classList.add('glowing');
                    }
                } else {
                    btn.classList.remove('active');
                    
                    if (device.includes('fan')) {
                        const fanIcon = btn.querySelector('.fan-icon');
                        if (fanIcon) fanIcon.classList.remove('spinning');
                    }
                    if (device.includes('light')) {
                        const lightIcon = btn.querySelector('.light-icon');
                        if (lightIcon) lightIcon.classList.remove('glowing');
                    }
                }
            }
        }

        // =================================================================
        // RFID FUNCTIONS
        // =================================================================
        async function startRfidScan() {
            console.log('🎫 Starting RFID scan, connection status:', systemState.isConnected);
            
            if (!systemState.isConnected) {
                alertManager.show('scan-error', '❌ Firebase not connected! Trying to reconnect...', 'danger', 3000);
                initializeFirebaseApp();
                return;
            }
            
            try {
                systemState.scanInProgress = true;
                
                await database.ref('/scanRequest/request').set(true);
                console.log('✅ Scan request sent to Firebase');
                
                document.getElementById('rfidScanStatus').textContent = 'Waiting for RFID card scan... Please place card on reader (30s)';
                document.getElementById('rfidScanStatus').style.background = 'var(--primary-color)';
                document.getElementById('rfidScanStatus').style.color = 'white';
                
                document.getElementById('btn-rfid-scan').innerHTML = '<div class="loading"></div> Scanning...';
                document.getElementById('btn-rfid-scan').disabled = true;
                document.getElementById('btn-rfid-stop').style.display = 'inline-flex';
                document.getElementById('rfidScanSection').classList.add('scanning');
                
                alertManager.show('scan-start', '🎫 RFID scan started!', 'success', 2000);
                
                let timeLeft = 30;
                const countdownInterval = setInterval(() => {
                    if (systemState.scanInProgress) {
                        timeLeft--;
                        document.getElementById('rfidScanStatus').textContent = `Waiting for RFID card scan... (${timeLeft}s)`;
                        if (timeLeft <= 0) {
                            clearInterval(countdownInterval);
                        }
                    } else {
                        clearInterval(countdownInterval);
                    }
                }, 1000);
                
                setTimeout(() => {
                    clearInterval(countdownInterval);
                    if (systemState.scanInProgress) {
                        stopRfidScan();
                        alertManager.show('scan-timeout', '⏰ Scan timeout', 'warning', 2000);
                    }
                }, 30000);
                
            } catch (error) {
                console.error('❌ Scan error:', error);
                alertManager.show('scan-error', '❌ Scan start error: ' + error.message, 'danger', 3000);
                systemState.scanInProgress = false;
                resetRfidScanButton();
            }
        }

        async function stopRfidScan() {
            systemState.scanInProgress = false;
            
            try {
                await database.ref('/scanRequest/request').set(false);
            } catch (error) {
                console.error('Stop scan error:', error);
            }
            
            resetRfidScanButton();
            alertManager.show('scan-stop', '⏹️ RFID scan stopped', 'warning', 2000);
        }

        function resetRfidScanButton() {
            document.getElementById('btn-rfid-scan').innerHTML = '<i class="fas fa-id-card"></i><span>Start Scanning</span>';
            document.getElementById('btn-rfid-scan').disabled = false;
            document.getElementById('btn-rfid-stop').style.display = 'none';
            document.getElementById('rfidScanSection').classList.remove('scanning');
            
            document.getElementById('rfidScanStatus').textContent = 'Press button to start scanning RFID cards';
            document.getElementById('rfidScanStatus').style.background = 'var(--surface-light)';
            document.getElementById('rfidScanStatus').style.color = 'var(--text-primary)';
        }

        async function addRfidCard() {
            const uid = document.getElementById('rfid-uid').value.trim().toUpperCase();
            const name = document.getElementById('rfid-name').value.trim();
            
            console.log('🎫 Adding RFID card:', uid, name, 'Connection:', systemState.isConnected);
            
            if (!uid || !name) {
                alertManager.show('rfid-input-error', '❌ Please enter complete information', 'danger', 2000);
                return;
            }
            
            if (!/^[A-F0-9]{8}$/.test(uid)) {
                alertManager.show('rfid-format-error', '❌ Invalid UID! Please enter 8 hex characters (0-9, A-F)', 'danger', 3000);
                return;
            }
            
            if (!systemState.isConnected) {
                alertManager.show('rfid-connection-error', '❌ Firebase not connected! Trying to reconnect...', 'danger', 3000);
                initializeFirebaseApp();
                return;
            }
            
            if (systemState.existingCards[uid]) {
                alertManager.show('rfid-exists', `❌ Card ${uid} already exists in system!`, 'warning', 2000);
                return;
            }
            
            try {
                document.getElementById('btn-rfid-add').disabled = true;
                document.getElementById('btn-rfid-add').innerHTML = '<div class="loading"></div> Adding...';
                
                const cardData = {
                    name: name,
                    addedAt: Date.now(),
                    addedBy: currentUser?.username || 'unknown'
                };
                
                await database.ref(`/cards/${uid}`).set(cardData);
                console.log('✅ RFID card added successfully');
                
                document.getElementById('rfid-uid').value = '';
                document.getElementById('rfid-name').value = '';
                
                alertManager.show('rfid-added', `✅ Added card ${uid} for ${name}`, 'success', 2000);
                
            } catch (error) {
                console.error('❌ Add card error:', error);
                alertManager.show('rfid-add-error', '❌ Error adding card: ' + error.message, 'danger', 3000);
            } finally {
                document.getElementById('btn-rfid-add').disabled = false;
                document.getElementById('btn-rfid-add').innerHTML = '<i class="fas fa-plus"></i><span>Add Card</span>';
            }
        }

        async function removeRfidCard(uid) {
            if (!confirm(`🗑️ Are you sure you want to delete card ${uid}?`)) {
                return;
            }
            
            try {
                await database.ref(`/cards/${uid}`).remove();
                alertManager.show('rfid-removed', `🗑️ Deleted card ${uid}`, 'success', 2000);
            } catch (error) {
                console.error('Remove card error:', error);
                alertManager.show('rfid-remove-error', '❌ Error deleting card: ' + error.message, 'danger', 3000);
            }
        }

        async function clearAllRfidCards() {
            if (confirm('🗑️ Confirm delete all RFID cards? This action cannot be undone!')) {
                try {
                    await database.ref('/cards').remove();
                    alertManager.show('rfid-cleared', '🗑️ Deleted all RFID cards', 'warning', 2000);
                } catch (error) {
                    alertManager.show('clear-error', '❌ Error deleting data: ' + error.message, 'danger', 3000);
                }
            }
        }

        function handleScannedUID(uid) {
            if (systemState.existingCards[uid]) {
                const cardName = systemState.existingCards[uid].name;
                document.getElementById('rfid-result').innerHTML = `
                    <div style="padding: 12px; border-radius: 10px; background: var(--surface-light); border: 2px solid var(--warning-color);">
                        <strong>⚠️ Card already exists:</strong> ${uid} (${cardName})
                    </div>
                `;
            } else {
                document.getElementById('rfid-result').innerHTML = `
                    <div style="padding: 12px; border-radius: 10px; background: var(--surface-light); border: 2px solid var(--success-color);">
                        <strong>✅ New card:</strong> ${uid}
                    </div>
                `;
                document.getElementById('rfid-uid').value = uid;
            }
            
            systemState.scanInProgress = false;
            resetRfidScanButton();
        }

        function updateCardsTable(cards) {
            if (Object.keys(cards).length === 0) {
                document.getElementById('rfid-table').innerHTML = `
                    <div style="text-align: center; color: var(--text-secondary); padding: 20px;">
                        <i class="fas fa-id-card" style="font-size: 48px; opacity: 0.3; margin-bottom: 12px;"></i>
                        <p>No RFID cards saved yet</p>
                    </div>
                `;
                return;
            }
            
            document.getElementById('rfid-table').innerHTML = Object.entries(cards).map(([uid, cardData]) => {
                const addedDate = cardData.addedAt ? new Date(cardData.addedAt).toLocaleDateString('en-US') : 'N/A';
                return `
                    <div class="list-item">
                        <div class="list-item-info">
                            <i class="fas fa-id-card"></i>
                            <span><strong>${uid}</strong> - ${cardData.name} (${addedDate})</span>
                        </div>
                        <button class="delete-btn" onclick="removeRfidCard('${uid}')">
                            <i class="fas fa-trash"></i>
                            <span>Delete</span>
                        </button>
                    </div>
                `;
            }).join('');
        }

        // =================================================================
        // CAMERA FUNCTIONS
        // =================================================================
        function testMotionDetection() {
            const motionTargets = document.querySelector('.motion-targets');
            const isCurrentlyDetected = motionTargets.classList.contains('motion-active');
            updateMotionStatus(!isCurrentlyDetected);
            
            if (!isCurrentlyDetected) {
                setTimeout(() => updateMotionStatus(false), 5000);
            }
        }

        function updateMotionStatus(detected) {
            systemState.motionDetected = detected;
            const motionTargets = document.querySelector('.motion-targets');
            
            if (detected) {
                document.getElementById('motionIndicator').className = 'motion-indicator motion-detected';
                document.getElementById('motionText').innerHTML = '<i class="fas fa-exclamation-triangle"></i> Motion Detected!';
                motionTargets.classList.add('motion-active');
                document.getElementById('radar-sweep').classList.add('scanning');
                
                document.getElementById('securityStatus').className = 'security-status alert';
                document.getElementById('securityStatus').innerHTML = '<i class="fas fa-exclamation-triangle"></i><span>Motion Alert</span>';
                
                alertManager.show('motion-detected', '⚠️ Motion detected at gate!', 'warning', 2000);
            } else {
                document.getElementById('motionIndicator').className = 'motion-indicator motion-clear';
                document.getElementById('motionText').innerHTML = '<i class="fas fa-shield-alt"></i> No Motion Detected';
                motionTargets.classList.remove('motion-active');
                document.getElementById('radar-sweep').classList.remove('scanning');
                
                document.getElementById('securityStatus').className = 'security-status armed';
                document.getElementById('securityStatus').innerHTML = '<i class="fas fa-shield-alt"></i><span>System Armed</span>';
            }
        }

        function updateCameraStatus(online) {
            systemState.cameraOnline = online;
            
            if (online) {
                document.getElementById('cameraStatusIndicator').className = 'camera-status-indicator online';
                document.getElementById('cameraStatusText').textContent = 'Camera Online';
                document.querySelector('.camera-status-dot').className = 'camera-status-dot online';
                
                document.getElementById('cameraIpDisplay').textContent = 'Stream: https://esp32stream.myfreeiot.win/stream';
                
                document.getElementById('btn-stream-toggle').disabled = false;
            } else {
                document.getElementById('cameraStatusIndicator').className = 'camera-status-indicator offline';
                document.getElementById('cameraStatusText').textContent = 'Camera Offline';
                document.querySelector('.camera-status-dot').className = 'camera-status-dot offline';
                document.getElementById('cameraIpDisplay').textContent = 'Stream: Waiting for connection...';
                
                document.getElementById('btn-stream-toggle').disabled = true;
                
                if (systemState.isStreaming) {
                    stopCameraStream();
                }
            }
        }

        function startCameraStream() {
            if (!systemState.cameraOnline) {
                alertManager.show('camera-offline', '❌ Camera not online!', 'danger');
                return;
            }
            
            const streamUrl = 'https://esp32stream.myfreeiot.win/stream';
            
            document.getElementById('cameraFeed').innerHTML = `
                <img class="camera-stream" src="${streamUrl}?t=${Date.now()}" 
                     alt="Camera Stream" 
                     onerror="handleStreamError(this)"
                     onload="handleStreamSuccess(this)">
            `;
            
            document.getElementById('cameraFeed').classList.add('loading');
            document.getElementById('btn-stream-toggle').innerHTML = '<div class="loading"></div> Connecting...';
            document.getElementById('btn-stream-toggle').disabled = true;
            
            setTimeout(() => {
                if (systemState.isStreaming) {
                    document.getElementById('btn-stream-toggle').innerHTML = '<i class="fas fa-stop"></i><span>Stop Stream</span>';
                    document.getElementById('btn-stream-toggle').disabled = false;
                    document.getElementById('btn-stream-toggle').className = 'btn btn-danger';
                }
            }, 3000);
        }

        function stopCameraStream() {
            systemState.isStreaming = false;
            document.getElementById('cameraFeed').classList.remove('loading');
            document.getElementById('cameraFeed').innerHTML = `
                <div class="camera-placeholder">
                    <i class="fas fa-video-slash"></i>
                    <div>Camera stream stopped</div>
                    <div style="font-size: 14px; margin-top: 10px; opacity: 0.7;">
                        Press "Start Stream" to view again
                    </div>
                </div>
            `;
            
            document.getElementById('btn-stream-toggle').innerHTML = '<i class="fas fa-video"></i><span>Start Stream</span>';
            document.getElementById('btn-stream-toggle').className = 'btn btn-warning';
            alertManager.show('stream-stopped', '📺 Camera stream stopped', 'info', 1500);
        }

        function toggleCameraStream() {
            if (systemState.isStreaming) {
                stopCameraStream();
            } else {
                startCameraStream();
            }
        }

        async function capturePhoto() {
            if (!systemState.cameraOnline) {
                alertManager.show('camera-offline', '❌ Camera not online!', 'danger', 2000);
                return;
            }
            
            try {
                const captureUrl = 'https://esp32stream.myfreeiot.win/capture';
                
                document.getElementById('btn-capture').innerHTML = '<div class="loading"></div> Capturing...';
                document.getElementById('btn-capture').disabled = true;
                
                const response = await fetch(captureUrl);
                if (response.ok) {
                    alertManager.show('capture-success', '📸 Photo captured successfully!', 'success', 2000);
                    
                    await database.ref('/cam/lastCaptureTime').set(Date.now());
                } else {
                    throw new Error('Capture failed');
                }
            } catch (error) {
                console.error('Capture error:', error);
                alertManager.show('capture-error', '❌ Photo capture error: ' + error.message, 'danger', 3000);
            } finally {
                document.getElementById('btn-capture').innerHTML = '<i class="fas fa-camera"></i><span>Manual Capture</span>';
                document.getElementById('btn-capture').disabled = false;
            }
        }

        // Global functions for stream handling
        window.handleStreamError = function(img) {
            console.error('Stream error');
            document.getElementById('cameraFeed').classList.remove('loading');
            document.getElementById('cameraFeed').innerHTML = `
                <div class="camera-placeholder">
                    <i class="fas fa-exclamation-triangle"></i>
                    <div>Cannot connect to camera stream</div>
                    <div style="font-size: 14px; margin-top: 10px; opacity: 0.7;">
                        Check ESP32-CAM connection
                    </div>
                </div>
            `;
            
            document.getElementById('btn-stream-toggle').innerHTML = '<i class="fas fa-video"></i><span>Start Stream</span>';
            document.getElementById('btn-stream-toggle').disabled = false;
            document.getElementById('btn-stream-toggle').className = 'btn btn-warning';
            
            alertManager.show('stream-error', '❌ Camera stream connection error!', 'danger', 2000);
        };
        
        window.handleStreamSuccess = function(img) {
            console.log('Stream connected successfully');
            systemState.isStreaming = true;
            document.getElementById('cameraFeed').classList.remove('loading');
            alertManager.show('stream-started', '📺 Camera stream connected!', 'success', 2000);
        };

        // =================================================================
        // 🔧 FIXED: ENERGY FLOW VISUALIZATION INITIALIZATION
        // =================================================================
        function initializeEnergyFlowVisualization() {
            console.log('🔧 Initializing Energy Flow Visualization - WAITING for ESP32 data...');
            
            let attempts = 0;
            const maxAttempts = 10;
            
            function tryInitialize() {
                attempts++;
                console.log(`🔧 Attempt ${attempts} to initialize energy flow...`);
                
                const canvas = document.getElementById('energyCanvas');
                if (!canvas) {
                    console.warn(`⚠️ Canvas not found on attempt ${attempts}`);
                    if (attempts < maxAttempts) {
                        setTimeout(tryInitialize, 100);
                    }
                    return;
                }
                
                console.log('✅ Canvas found:', canvas);
                
                if (!energyFlowAnimation) {
                    try {
                        energyFlowAnimation = new EnergyFlowVisualization('energyCanvas');
                        console.log('✅ Energy flow visualization initialized - waiting for real data');
                        
                    } catch (error) {
                        console.error('❌ Error creating EnergyFlowVisualization:', error);
                        if (attempts < maxAttempts) {
                            setTimeout(tryInitialize, 200);
                        }
                    }
                } else {
                    console.log('✅ Energy flow already initialized');
                }
            }
            
            tryInitialize();
            setTimeout(tryInitialize, 100);
            setTimeout(tryInitialize, 300);
            setTimeout(tryInitialize, 500);
        }

        // Initialize Charts
        function initializeCharts() {
            // Temperature & Humidity Chart
            const tempHumidCtx = document.getElementById('tempHumidChart').getContext('2d');
            charts.tempHumid = new Chart(tempHumidCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Temperature (°C)',
                        data: [],
                        borderColor: '#ef4444',
                        backgroundColor: '#ef444420',
                        yAxisID: 'y',
                        tension: 0.4,
                        pointRadius: 3,
                        pointHoverRadius: 6
                    }, {
                        label: 'Humidity (%)',
                        data: [],
                        borderColor: '#3b82f6',
                        backgroundColor: '#3b82f620',
                        yAxisID: 'y1',
                        tension: 0.4,
                        pointRadius: 3,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 200 },
                    interaction: { mode: 'index', intersect: false },
                    plugins: { legend: { labels: { color: '#fff' } } },
                    scales: {
                        x: { ticks: { color: '#fff' }, grid: { color: '#ffffff20' } },
                        y: {
                            type: 'linear', display: true, position: 'left',
                            min: 0, max: 50, ticks: { color: '#ef4444', stepSize: 5 },
                            grid: { color: '#ffffff20' },
                            title: { display: true, text: 'Temperature (°C)', color: '#ef4444' }
                        },
                        y1: {
                            type: 'linear', display: true, position: 'right',
                            min: 0, max: 100, ticks: { color: '#3b82f6', stepSize: 10 },
                            grid: { drawOnChartArea: false },
                            title: { display: true, text: 'Humidity (%)', color: '#3b82f6' }
                        }
                    }
                }
            });
            
            // Gas Chart
            const gasCtx = document.getElementById('gasChart').getContext('2d');
            charts.gas = new Chart(gasCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Gas Concentration (ppm)',
                        data: [],
                        borderColor: '#f59e0b',
                        backgroundColor: '#f59e0b20',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointHoverRadius: 8,
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 200 },
                    plugins: { legend: { labels: { color: '#fff' } } },
                    scales: {
                        x: { ticks: { color: '#fff' }, grid: { color: '#ffffff20' } },
                        y: {
                            min: 0, max: 2000,
                            ticks: { color: '#fff', stepSize: 200 },
                            grid: { color: '#ffffff20' },
                            title: { display: true, text: 'ppm', color: '#fff' }
                        }
                    }
                }
            });
            
            // Energy Chart
            const energyCtx = document.getElementById('energyChart').getContext('2d');
            charts.energy = new Chart(energyCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Solar (W)',
                        data: [],
                        backgroundColor: '#f59e0b80',
                        borderColor: '#f59e0b',
                        borderWidth: 2
                    }, {
                        label: 'LiPo Battery (W)',
                        data: [],
                        backgroundColor: '#10b98180',
                        borderColor: '#10b981',
                        borderWidth: 2
                    }, {
                        label: 'Adapter (W)',
                        data: [],
                        backgroundColor: '#ef444480',
                        borderColor: '#ef4444',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 200 },
                    plugins: { legend: { labels: { color: '#fff' } } },
                    scales: {
                        x: { stacked: true, ticks: { color: '#fff' }, grid: { color: '#ffffff20' } },
                        y: {
                            stacked: true, min: 0, max: 15,
                            ticks: { color: '#fff', stepSize: 1 },
                            grid: { color: '#ffffff20' },
                            title: { display: true, text: 'Power (W)', color: '#fff' }
                        }
                    }
                }
            });
        }

        // Add sensor data with sync
        function addSensorData(type, value) {
            const currentTime = new Date().toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit' 
            });
            const now = Date.now();
            const maxDataPoints = 20;
            
            latestSensorValues[type] = value;
            latestSensorValues[`last${type.charAt(0).toUpperCase() + type.slice(1)}Time`] = now;
            
            if (latestSensorValues.temp !== null && latestSensorValues.humid !== null) {
                sensorData.temp.push(latestSensorValues.temp);
                sensorData.humid.push(latestSensorValues.humid);
                sensorData.timestamps.push(currentTime);
                
                if (sensorData.temp.length > maxDataPoints) {
                    sensorData.temp.shift();
                    sensorData.humid.shift();
                    sensorData.timestamps.shift();
                }
            }
            
            updateSensorCharts();
        }
        
        // Update sensor charts
        function updateSensorCharts() {
            const minLength = Math.min(
                sensorData.temp.length, 
                sensorData.humid.length, 
                sensorData.timestamps.length
            );
            
            if (charts.tempHumid && minLength > 0) {
                charts.tempHumid.data.labels = sensorData.timestamps.slice(-minLength);
                charts.tempHumid.data.datasets[0].data = sensorData.temp.slice(-minLength);
                charts.tempHumid.data.datasets[1].data = sensorData.humid.slice(-minLength);
                charts.tempHumid.update('none');
            }
            
            if (charts.gas && sensorData.gas.length > 0) {
                charts.gas.data.labels = [...sensorData.timestamps.slice(-minLength)];
                charts.gas.data.datasets[0].data = [...sensorData.gas.slice(-minLength)];
                charts.gas.update('none');
            }
        }
        
        // Add energy data
        function addEnergyData(solar, battery, adapter) {
            const currentTime = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            const maxDataPoints = 20;
            
            energyData.solar.push(Math.min(solar, 15));
            energyData.battery.push(Math.min(battery, 15));
            energyData.adapter.push(Math.min(adapter, 15));
            
            if (energyData.solar.length > maxDataPoints) energyData.solar.shift();
            if (energyData.battery.length > maxDataPoints) energyData.battery.shift();
            if (energyData.adapter.length > maxDataPoints) energyData.adapter.shift();
            if (energyData.timestamps.length > maxDataPoints) energyData.timestamps.shift();
            
            energyData.timestamps.push(currentTime);
            
            updateEnergyChart();
        }
        
        // Update energy chart
        function updateEnergyChart() {
            if (charts.energy) {
                charts.energy.data.labels = [...energyData.timestamps];
                charts.energy.data.datasets[0].data = [...energyData.solar];
                charts.energy.data.datasets[1].data = [...energyData.battery];
                charts.energy.data.datasets[2].data = [...energyData.adapter];
                charts.energy.update('none');
            }
        }

        // Update Weather
        async function updateWeather() {
            try {
                const mockWeatherData = {
                    temp: 28 + Math.random() * 5,
                    humidity: 60 + Math.random() * 20,
                    wind: 5 + Math.random() * 10,
                    rain: Math.random() * 2,
                    visibility: 8 + Math.random() * 2,
                    description: 'Partly Sunny',
                    icon: 'fa-sun'
                };
                
                document.getElementById('weatherTemp').textContent = Math.round(mockWeatherData.temp) + '°C';
                document.getElementById('weatherDesc').textContent = mockWeatherData.description;
                document.getElementById('weatherHumidity').textContent = Math.round(mockWeatherData.humidity) + '%';
                document.getElementById('weatherWind').textContent = mockWeatherData.wind.toFixed(1) + ' km/h';
                document.getElementById('weatherRain').textContent = mockWeatherData.rain.toFixed(1) + ' mm';
                document.getElementById('weatherVisibility').textContent = mockWeatherData.visibility.toFixed(1) + ' km';
                document.getElementById('weatherIcon').innerHTML = `<i class="fas ${mockWeatherData.icon}"></i>`;
            } catch (error) {
                console.error('Error updating weather:', error);
            }
        }

        // =================================================================
        // HISTORY FUNCTIONS
        // =================================================================
        function updateHistoryTable(history) {
            systemState.accessHistory = [];
            
            if (Object.keys(history).length === 0) {
                document.getElementById('historyTableBody').innerHTML = '<tr><td colspan="6" style="text-align: center;">No history yet</td></tr>';
                return;
            }
            
            const sortedHistory = Object.entries(history).sort((a, b) => {
                return (b[1].timestamp || 0) - (a[1].timestamp || 0);
            });
            
            sortedHistory.forEach(([key, event]) => {
                const timestamp = event.timestamp ? new Date(event.timestamp * 1000) : new Date();
                systemState.accessHistory.push({
                    key,
                    timestamp: timestamp.toLocaleString('en-US'),
                    date: timestamp.toISOString().split('T')[0],
                    type: event.type,
                    uid: event.uid || '-',
                    name: event.name || '-',
                    rawEvent: event
                });
            });
            
            displayHistoryTable(systemState.accessHistory);
        }
        
        function displayHistoryTable(historyData) {
            if (historyData.length === 0) {
                document.getElementById('historyTableBody').innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--text-secondary);">No data matching filter criteria</td></tr>';
                return;
            }
            
            document.getElementById('historyTableBody').innerHTML = historyData.map(item => {
                const eventType = getEventTypeDisplay(item.type);
                const status = getEventStatus(item.type);
                
                return `
                    <tr>
                        <td>${item.timestamp}</td>
                        <td>${eventType}</td>
                        <td><code>${item.uid}</code></td>
                        <td>${item.name}</td>
                        <td>${status}</td>
                        <td><span class="action-badge">${getEventAction(item.type)}</span></td>
                    </tr>
                `;
            }).join('');
        }
        
        function applyHistoryFilter() {
            const date = document.getElementById('filterDate').value;
            const method = document.getElementById('filterMethod').value;
            const result = document.getElementById('filterResult').value;
            
            let filteredHistory = [...systemState.accessHistory];
            
            if (date) {
                filteredHistory = filteredHistory.filter(item => item.date === date);
            }
            
            if (method) {
                filteredHistory = filteredHistory.filter(item => {
                    switch (method) {
                        case 'rfid':
                            return item.type.includes('rfid') || item.type.includes('gate');
                        case 'motion':
                            return item.type.includes('motion');
                        case 'manual':
                            return item.type.includes('manual') || item.type.includes('gate');
                        default:
                            return true;
                    }
                });
            }
            
            if (result) {
                filteredHistory = filteredHistory.filter(item => {
                    if (result === 'success') {
                        return item.type.includes('success') || item.type.includes('open') || item.type.includes('close');
                    } else if (result === 'failed') {
                        return item.type.includes('fail') || item.type.includes('alert');
                    }
                    return true;
                });
            }
            
            displayHistoryTable(filteredHistory);
            alertManager.show('filter-applied', `🔍 Filtered ${filteredHistory.length} results`, 'info', 1500);
        }

        function getEventTypeDisplay(type) {
            const types = {
                'gate_open': '<span class="method-badge method-rfid"><i class="fas fa-door-open"></i> Gate Open</span>',
                'gate_close': '<span class="method-badge method-rfid"><i class="fas fa-door-closed"></i> Gate Close</span>',
                'rfid_success': '<span class="method-badge method-rfid"><i class="fas fa-id-card"></i> RFID</span>',
                'rfid_fail': '<span class="method-badge method-rfid"><i class="fas fa-id-card"></i> RFID</span>',
                'motion_capture': '<span class="method-badge method-motion"><i class="fas fa-running"></i> Motion Sensor</span>'
            };
            return types[type] || `<span class="method-badge method-rfid">${type}</span>`;
        }

        function getEventStatus(type) {
            if (type.includes('success') || type.includes('open') || type.includes('close')) {
                return '<span class="status-badge status-success"><i class="fas fa-check"></i> Success</span>';
            } else if (type.includes('fail') || type.includes('alert')) {
                return '<span class="status-badge status-failed"><i class="fas fa-times"></i> Failed</span>';
            } else {
                return '<span class="status-badge status-success"><i class="fas fa-info"></i> Info</span>';
            }
        }

        function getEventAction(type) {
            const actions = {
                'gate_open': 'Open Gate',
                'gate_close': 'Close Gate',
                'rfid_success': 'Access',
                'rfid_fail': 'Denied',
                'motion_capture': 'Photo'
            };
            return actions[type] || 'Other';
        }

        // =================================================================
        // 🔥 FIXED: FIREBASE LISTENERS WITH GAS ALERT SUPPORT
        // =================================================================
        function setupFirebaseListeners() {
            // Gate status listener
            database.ref('/gate/status').on('value', (snapshot) => {
                const status = snapshot.val() || 'unknown';
                updateGateStatus(status);
            });
            
            // Temperature listener
            database.ref('/sensors/temperature').on('value', (snapshot) => {
                if (snapshot.exists()) {
                    const temp = snapshot.val();
                    document.getElementById('tempValue').textContent = temp.toFixed(1);
                    latestSensorValues.temp = temp;
                    latestSensorValues.lastTempTime = Date.now();
                    
                    if (sensorData.temp.length > 0) {
                        sensorData.temp[sensorData.temp.length - 1] = temp;
                        updateSensorCharts();
                    }
                    
                    addSensorData('temp', temp);
                }
            });
            
            // Humidity listener
            database.ref('/sensors/humidity').on('value', (snapshot) => {
                if (snapshot.exists()) {
                    const humid = snapshot.val();
                    document.getElementById('humidValue').textContent = humid.toFixed(1);
                    latestSensorValues.humid = humid;
                    latestSensorValues.lastHumidTime = Date.now();
                    
                    if (sensorData.humid.length > 0) {
                        sensorData.humid[sensorData.humid.length - 1] = humid;
                        updateSensorCharts();
                    }
                    
                    addSensorData('humid', humid);
                }
            });
            
            // 🔥 FIXED: Gas sensor listener with alert processing
            database.ref('/sensors/gas').on('value', (snapshot) => {
                if (snapshot.exists()) {
                    const gasData = snapshot.val();
                    const gasPPM = gasData.ppm || 0;
                    const gasValue = gasData.value || 0;
                    const isCalibrated = gasData.isCalibrated || false;
                    
                    updateGasStatus(isCalibrated, gasPPM, gasValue);
                    
                    if (charts.gas) {
                        charts.gas.data.labels = [...sensorData.timestamps];
                        charts.gas.data.datasets[0].data = [...sensorData.gas];
                        charts.gas.update('none');
                    }
                    
                    // 🔥 FIXED: Process gas alerts from sensor data
                    if (isCalibrated && gasPPM > 200) {
                        const level = gasPPM > 800 ? 'DANGER' : 'WARNING';
                        updateGasAlertStatus(level, gasPPM, `Gas level: ${gasPPM.toFixed(0)} ppm`);
                    } else if (gasPPM <= 200 * 0.8) {
                        updateGasAlertStatus('NORMAL', gasPPM, 'Gas level normal');
                    }
                }
            });
            
            // 🔥 FIXED: Gas alerts listener (from ESP32 alerts)
            database.ref('/alerts').on('value', (snapshot) => {
                if (snapshot.exists()) {
                    const alerts = snapshot.val();
                    
                    if (alerts.gasHigh && alerts.gasLevel && alerts.gasMessage) {
                        console.log('🔥 Gas alert from ESP32:', alerts);
                        
                        // Update gas alert status
                        const ppm = parseFloat(alerts.gasMessage.match(/(\d+(?:\.\d+)?)\s*ppm/)?.[1] || '0');
                        updateGasAlertStatus(alerts.gasLevel, ppm, alerts.gasMessage);
                        
                        // Show notification based on level
                        if (alerts.gasLevel === 'DANGER') {
                            alertManager.show('esp32-gas-danger', 
                                `🚨 ESP32 GAS DANGER! ${alerts.gasMessage}`, 
                                'danger', 15000);
                        } else if (alerts.gasLevel === 'WARNING') {
                            alertManager.show('esp32-gas-warning', 
                                `⚠️ ESP32 Gas Warning: ${alerts.gasMessage}`, 
                                'warning', 10000);
                        }
                    } else if (alerts.gasHigh === false && alerts.gasLevel === 'NORMAL') {
                        // Clear gas alert
                        updateGasAlertStatus('NORMAL', 0, 'Gas level normal');
                    }
                }
            });
            
            database.ref('/sensors/light/isDark').on('value', (snapshot) => {
                if (snapshot.exists()) {
                    const isDark = snapshot.val();
                    document.getElementById('lightStatus').textContent = isDark ? 'Dark' : 'Bright';
                }
            });
            
            // 🔧 FIXED: Power data listeners - Show energy flow when data available
            database.ref('/power').on('value', (snapshot) => {
                if (snapshot.exists()) {
                    const powerData = snapshot.val();
                    
                    const solarPower = powerData.solar?.power || 0;
                    const batteryPower = powerData.battery?.power || 0;
                    const adapterPower = powerData.adapter?.power || 0;
                    const totalPower = powerData.totalPower || 0;
                    
                    // Enhanced validation
                    energyFlowState.powerValidation.solar = powerData.solar?.isValid || false;
                    energyFlowState.powerValidation.battery = powerData.battery?.isValid || false;
                    energyFlowState.powerValidation.adapter = powerData.adapter?.isValid || false;
                    
                    // 🔧 FIXED: Show energy flow UI when data is available
                    if (!energyFlowState.hasData) {
                        energyFlowState.hasData = true;
                        
                        // Show energy flow components
                        document.getElementById('powerSourceIndicator').classList.add('data-available');
                        document.getElementById('energyStats').classList.add('data-available');
                        
                        console.log('🔧 Energy Flow: ESP32 data available, showing UI components');
                    }
                    
                    updateValidationIndicator('solarValidation', energyFlowState.powerValidation.solar);
                    updateValidationIndicator('batteryValidation', energyFlowState.powerValidation.battery);
                    updateValidationIndicator('adapterValidation', energyFlowState.powerValidation.adapter);
                    
                    const percentages = powerData.percentages || { solar: 0, battery: 0, adapter: 0 };
                    document.getElementById('solarPercent').textContent = percentages.solar.toFixed(0) + '%';
                    document.getElementById('batteryPercent').textContent = percentages.battery.toFixed(0) + '%';
                    document.getElementById('adapterPercent').textContent = percentages.adapter.toFixed(0) + '%';
                    
                    document.getElementById('solarDetails').textContent = 
                        `${(solarPower/1000).toFixed(1)}W | ${(powerData.solar?.voltage || 0).toFixed(1)}V`;
                    
                    const batteryPercent = powerData.battery?.percent || 0;
                    document.getElementById('batteryDetails').textContent = 
                        `${(Math.abs(batteryPower)/1000).toFixed(1)}W | ${(powerData.battery?.voltage || 0).toFixed(1)}V | ${batteryPercent.toFixed(0)}%`;
                    
                    document.getElementById('adapterDetails').textContent = 
                        `${(adapterPower/1000).toFixed(1)}W | ${(powerData.adapter?.voltage || 0).toFixed(1)}V`;
                    
                    energyFlowState.currentPowerSource = powerData.currentSource || 0;
                    updatePowerSourceIndicator(energyFlowState.currentPowerSource, totalPower);
                    
                    // Update energy flow with real ESP32 data
                    if (energyFlowAnimation) {
                        energyFlowAnimation.update(energyFlowState.currentPowerSource, {
                            solar: solarPower / 1000,
                            battery: batteryPower / 1000,
                            adapter: adapterPower / 1000,
                            total: totalPower,
                            solarV: powerData.solar?.voltage || 0,
                            batteryV: powerData.battery?.voltage || 0,
                            adapterV: powerData.adapter?.voltage || 0
                        }, energyFlowState.powerValidation);
                    }
                    
                    const solarW = solarPower / 1000;
                    const batteryW = Math.abs(batteryPower) / 1000;
                    const adapterW = adapterPower / 1000;
                    
                    addEnergyData(solarW, batteryW, adapterW);
                }
            });
            
            // Enhanced Battery SoC Listener with fallback calculation
            database.ref('/power/battery').on('value', (snapshot) => {
                if (snapshot.exists()) {
                    const batteryData = snapshot.val();
                    updateBatteryWidget(batteryData);
                    
                    if (batteryData.soc && batteryData.soc.combined !== undefined) {
                        const combinedSoC = batteryData.soc.combined;
                        document.getElementById('batteryPercent').textContent = combinedSoC.toFixed(0) + '%';
                        
                        const batteryPower = Math.abs(batteryData.power || 0) / 1000;
                        const batteryVoltage = batteryData.voltage || 0;
                        const batteryPercent = combinedSoC;
                        
                        document.getElementById('batteryDetails').textContent = 
                            `${batteryPower.toFixed(1)}W | ${batteryVoltage.toFixed(1)}V | ${batteryPercent.toFixed(0)}%`;
                    } else if (batteryData.voltage && batteryData.voltage > 0) {
                        const fallbackSoC = calculateBatterySoC(batteryData.voltage);
                        document.getElementById('batteryPercent').textContent = fallbackSoC.toFixed(0) + '%';
                        
                        const batteryPower = Math.abs(batteryData.power || 0) / 1000;
                        const batteryVoltage = batteryData.voltage || 0;
                        
                        document.getElementById('batteryDetails').textContent = 
                            `${batteryPower.toFixed(1)}W | ${batteryVoltage.toFixed(1)}V | ${fallbackSoC.toFixed(0)}%`;
                            
                        console.log(`🔋 Fallback SoC: ${batteryVoltage}V → ${fallbackSoC.toFixed(1)}%`);
                    }
                }
            });
            
            // Device state listeners
            ['light1', 'light2', 'light3', 'light4', 'fan1', 'fan2', 'fan3', 'autoLight'].forEach(device => {
                database.ref(`/devices/${device}/state`).on('value', (snapshot) => {
                    if (snapshot.exists() && !pendingCommands.has(device)) {
                        const state = snapshot.val();
                        deviceStates[device] = state;
                        updateDeviceUI(device, state);
                    }
                });
            });
            
            // RFID listeners
            database.ref('/lastScanned/uid').on('value', (snapshot) => {
                const uid = snapshot.val();
                if (uid && systemState.scanInProgress) {
                    handleScannedUID(uid);
                }
            });
            
            database.ref('/cards').on('value', (snapshot) => {
                const cards = snapshot.val() || {};
                systemState.existingCards = cards;
                updateCardsTable(cards);
            });
            
            database.ref('/history').limitToLast(50).on('value', (snapshot) => {
                const history = snapshot.val() || {};
                updateHistoryTable(history);
            });
            
            // Camera listeners
            database.ref('/cam/ip').on('value', (snapshot) => {
                const ip = snapshot.val();
                if (ip && ip !== systemState.currentCameraIP) {
                    systemState.currentCameraIP = ip;
                    systemState.cameraStreamUrl = `http://${ip}/stream`;
                    document.getElementById('cameraIpDisplay').textContent = `Stream: http://${ip}/stream`;
                    console.log('Camera IP updated:', ip);
                }
            });
            
            database.ref('/cam/status/online').on('value', (snapshot) => {
                const online = snapshot.val() || false;
                updateCameraStatus(online);
                
                if (online && !systemState.isStreaming) {
                    setTimeout(() => startCameraStream(), 2000);
                }
            });
            
            database.ref('/sensors/motion').on('value', (snapshot) => {
                const motion = snapshot.val() || false;
                updateMotionStatus(motion);
            });
            
            // System status listener
            database.ref('/system/status').on('value', (snapshot) => {
                if (snapshot.exists()) {
                    const status = snapshot.val();
                    updateConnectionStatus(status === 'online');
                }
            });
        }

        // Update connection status
        function updateConnectionStatus(connected) {
            systemState.isConnected = connected;
            
            if (connected) {
                document.getElementById('connectionStatus').className = 'connection-status connected';
                document.getElementById('connectionStatus').innerHTML = '<i class="fas fa-circle"></i><span>Firebase Connected</span>';
            } else {
                document.getElementById('connectionStatus').className = 'connection-status disconnected';
                document.getElementById('connectionStatus').innerHTML = '<i class="fas fa-circle"></i><span>Disconnected</span>';
            }
        }

        function updateGateStatus(status) {
            const statusMap = {
                'open': { text: 'Open', class: 'status-open' },
                'closed': { text: 'Closed', class: 'status-closed' },
                'opening': { text: 'Opening', class: 'status-opening' },
                'closing': { text: 'Closing', class: 'status-closing' }
            };
            
            const statusInfo = statusMap[status] || statusMap['closed'];
            
            const doorStatusText = document.getElementById('doorStatusText');
            const doorStatus = document.getElementById('doorStatus');
            const doorPanel = document.getElementById('doorPanel');
            
            if (doorStatusText) doorStatusText.textContent = statusInfo.text;
            if (doorStatus) doorStatus.className = `door-status ${statusInfo.class}`;
            
            if (doorPanel) {
                doorPanel.classList.remove('open');
                if (status === 'open') {
                    doorPanel.classList.add('open');
                }
            }
        }

        // Update validation indicators
        function updateValidationIndicator(elementId, isValid) {
            const indicator = document.getElementById(elementId);
            if (indicator) {
                indicator.className = `validation-indicator ${isValid ? 'valid' : 'invalid'}`;
            }
        }

        // Update Power Source Indicator
        function updatePowerSourceIndicator(source, totalPower) {
            const icon = document.getElementById('powerSourceIcon');
            const text = document.getElementById('powerSourceText');
            const details = document.getElementById('powerSourceDetails');
            
            let sourceInfo = {
                1: { name: 'Solar Energy', icon: 'fa-sun', color: '#f59e0b' },
                2: { name: 'LiPo Battery', icon: 'fa-battery-three-quarters', color: '#10b981' },
                3: { name: '12V Adapter', icon: 'fa-plug', color: '#ef4444' },
                0: { name: 'No Power Source', icon: 'fa-question', color: '#6b7280' }
            };
            
            const info = sourceInfo[source] || sourceInfo[0];
            
            icon.style.background = info.color;
            icon.innerHTML = `<i class="fas ${info.icon}"></i>`;
            text.textContent = info.name;
            details.textContent = `${totalPower.toFixed(1)} W`;
        }

        // 🔥 FIXED: Update Gas Status with enhanced visual alerts
        function updateGasStatus(isCalibrated, gasPPM, gasValue) {
            const gasStatus = document.getElementById('gasStatus');
            const gasItem = document.getElementById('gasItem');
            
            gasItem.classList.remove('gas-alert', 'gas-warning');
            
            if (!isCalibrated) {
                gasStatus.textContent = 'Starting up...';
                gasStatus.className = 'sensor-status warming';
                sensorData.gas.push(0);
                if (sensorData.gas.length > 20) sensorData.gas.shift();
            } else {
                document.getElementById('gasValue').innerHTML = `${gasPPM.toFixed(0)} <small>(Raw: ${gasValue})</small>`;
                
                sensorData.gas.push(gasPPM);
                if (sensorData.gas.length > 20) sensorData.gas.shift();
                
                if (gasPPM > 800) {
                    gasStatus.textContent = 'DANGER!';
                    gasStatus.className = 'sensor-status';
                    gasStatus.style.background = '#ef4444';
                    gasStatus.style.color = '#fff';
                    gasItem.classList.add('gas-alert');
                } else if (gasPPM > 200) {
                    gasStatus.textContent = 'Warning';
                    gasStatus.className = 'sensor-status';
                    gasStatus.style.background = '#fbbf24';
                    gasStatus.style.color = '#000';
                    gasItem.classList.add('gas-warning');
                } else {
                    gasStatus.textContent = 'Normal';
                    gasStatus.className = 'sensor-status ready';
                    gasStatus.style.background = '#4ade80';
                    gasStatus.style.color = '#000';
                }
            }
        }

        // =================================================================
        // INITIALIZATION
        // =================================================================
        document.addEventListener('DOMContentLoaded', async () => {
            createParticles();
            
            console.log('🔋 Smart Home System v3.2 + AI Face Recognition - FIXED VERSION');
            console.log('🔥 FIXED: Gas Alert System - Dashboard now listens to ESP32 alerts');
            console.log('⚡ FIXED: Energy Flow - No demo data, waits for real ESP32 INA219 data');
            console.log('🤖 Face Recognition Features: Domain Separation + Auto Capture + Fixed Recognition');
            
            if (!(await checkAuth())) {
                showPage('login');
            }
            
            // Login form handler
            document.getElementById('loginForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                login(username, password);
            });
            
            // Create user form handler
            document.getElementById('createUserForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const username = document.getElementById('newUsername').value;
                const password = document.getElementById('newPassword').value;
                const displayName = document.getElementById('newDisplayName').value;
                createUser(username, password, displayName);
            });
            
            // Admin panel button
            document.getElementById('adminPanelBtn').addEventListener('click', () => {
                showPage('admin');
            });

            // Auto-convert UID input to uppercase
            const rfidUidInput = document.getElementById('rfid-uid');
            if (rfidUidInput) {
                rfidUidInput.addEventListener('input', function(e) {
                    e.target.value = e.target.value.toUpperCase();
                });
            }

            // Set today's date for filter
            const today = new Date();
            const dateString = today.getFullYear() + '-' + 
                String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                String(today.getDate()).padStart(2, '0');
            const filterDate = document.getElementById('filterDate');
            if (filterDate) {
                filterDate.value = dateString;
            }

            // Monitor Firebase connection status
            setInterval(() => {
                if (systemState.isConnected) {
                    database.ref('test/ping').set(Date.now()).catch(() => {
                        console.log('⚠️ Firebase connection lost, attempting reconnect...');
                        systemState.isConnected = false;
                        updateConnectionStatus(false);
                        initializeFirebaseApp();
                    });
                }
            }, 10000);

            console.log('🚀 FIXED Smart Home System + Face Recognition ready!');
            console.log('🔥 Gas alerts will now show on dashboard when ESP32 detects leaks');
            console.log('⚡ Energy flow will display when ESP32 sends real INA219 power data');
        });

        // ESC key handler for face recognition
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const videoContainer = document.querySelector('.video-container');
                if (videoContainer && videoContainer.classList.contains('video-fullscreen')) {
                    toggleFullscreen();
                }
                
                if (faceState.enrollmentActive) {
                    forceStopCapture();
                }
            }
        });

        // Global functions
        window.login = login;
        window.logout = logout;
        window.showPage = showPage;
        window.switchTab = switchTab;
        window.controlGate = controlGate;
        window.toggleHomeDevice = toggleHomeDevice;
        window.createUser = createUser;
        window.deleteUser = deleteUser;
        window.startRfidScan = startRfidScan;
        window.stopRfidScan = stopRfidScan;
        window.addRfidCard = addRfidCard;
        window.removeRfidCard = removeRfidCard;
        window.clearAllRfidCards = clearAllRfidCards;
        window.testMotionDetection = testMotionDetection;
        window.capturePhoto = capturePhoto;
        window.toggleCameraStream = toggleCameraStream;
        window.applyHistoryFilter = applyHistoryFilter;
        window.alertManager = alertManager;

        // Face Recognition Global Functions
        window.startFixedEnrollment = startFixedEnrollment;
        window.stopEnrollment = stopEnrollment;
        window.manualCaptureFixed = manualCaptureFixed;
        window.performRecognition = performRecognition;
        window.instantCapture = instantCapture;
        window.enrollFace = enrollFace;
        window.deleteFace = deleteFace;
        window.loadFaceList = loadFaceList;
        window.clearCaptures = clearCaptures;
        window.forceStopCapture = forceStopCapture;
        window.startStream = startStream;
        window.stopStream = stopStream;
        window.toggleFullscreen = toggleFullscreen;

        console.log('🔋 Smart Home Enhanced Battery SoC System v3.2 + AI Face Recognition - FIXED READY!');
        console.log('📋 Default Admin Account (stored in Firebase):');
        console.log('   Username: admin');
        console.log('   Password: admin123');
        console.log('🔧 FIXED Issues:');
        console.log('   ✅ Gas Alert System: ESP32 alerts now show on dashboard with visual indicators');
        console.log('   ✅ Energy Flow Logic: No demo data, waits for real ESP32 INA219 power readings');
        console.log('   ✅ Power validation uses actual INA219 isValid flags from ESP32');
        console.log('   ✅ Energy stats hidden until ESP32 data available');
        console.log('   ✅ Gas alerts trigger visual warnings and notifications');
        console.log('   ✅ Face recognition with enhanced capture methods');
        console.log('🔥 Gas Alert Features:');
        console.log('   ✅ Real-time monitoring from ESP32 MQ-2 sensor');
        console.log('   ✅ Visual gas alert status indicator');
        console.log('   ✅ Dashboard notifications for WARNING and DANGER levels');
        console.log('   ✅ Kitchen sensor animation during gas alerts');
        console.log('⚡ Energy Flow Features:');
        console.log('   ✅ Displays "Waiting for Power Data" until ESP32 connects');
        console.log('   ✅ Shows energy flow only when INA219 data is valid');
        console.log('   ✅ Uses real voltage/current/power from ESP32 sensors');
        console.log('   ✅ Accurate power source detection based on ESP32 logic');
        console.log('🎯 RESULT: Fully functional Smart Home Dashboard with accurate sensor integration!');
    </script>
</body>
</html>
